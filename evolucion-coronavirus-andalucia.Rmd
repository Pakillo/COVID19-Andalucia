---
title: "Datos COVID-19 Andalucía: evolución y situación actual"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    theme: flatly
    toc: no
    self_contained: no
    includes: 
      in_header: header.html
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46538450-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-46538450-3');
</script>


```{r metathis, echo=FALSE}
library(metathis)
meta() %>% 
  meta_description("Información diaria sobre casos detectados, ingresos, defunciones, vacunación, etc. a escala de municipio, provincia y comunidad autónoma") %>% 
  meta_subject("COVID-19 en Andalucía: datos por municipio, provincia y comunidad autónoma") %>% 
  meta_geo(geo_placename = "Andalucia",
           geo_region = "ES-AN")
```



```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%")

knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)

# Garrick Adenbuie's gist to place TOC anywhere
# devtools::source_gist("c83e078bf8c81b035e32c3fc0cf04ee8", 
#                       filename = 'render_toc.R')
source("render_toc.R")
```

```{r pkgs, include=FALSE}
library(dplyr)
library(ggplot2)
#library(plotly)

mytheme <- theme_minimal(base_size = 14) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(size = 8, face = "italic", colour = "grey60"),
        plot.subtitle = element_text(size = 11, face = "plain", colour = "grey50"),
        axis.ticks = element_line(colour = "grey80"),
        axis.ticks.length = unit(3, "pt"),
        strip.text = element_text(size = 12))
theme_set(mytheme)
```

<br>

**Datos diarios de casos, ingresos y defunciones por rango de edad, municipio, provincia y comunidad autónoma.**

---

Aquí se visualiza la evolución de la enfermedad COVID-19 causada por el coronavirus SARS-CoV2 en Andalucía, según los datos ofrecidos por la [Junta de Andalucía](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html), el [Ministerio de Sanidad](https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/situacionActual.htm?q=service/), la [Fundación CIVIO](https://datos.civio.es/) y [Datadista](https://github.com/datadista/datasets/tree/master/COVID%2019). Se incluyen casos detectados, ingresos, defunciones, letalidad, etc por rango de edad y a escala de municipio, provincia y comunidad autónoma.

Los datos se **actualizan diariamente**. En esta [cuenta de twitter](https://twitter.com/covid_andalucia) compartiremos la información más relevante. Tanto los datos como el código empleado para generar estas visualizaciones está disponible [aquí](https://github.com/Pakillo/COVID19-Andalucia). 

Última actualización: `r Sys.Date()`

### Índice

```{r render.toc}
render_toc("evolucion-coronavirus-andalucia.Rmd", base_level = 2, toc_depth = 2)
```




```{r datos}

library(readr)
library(assertr)

#datos <- readxl::read_excel("datos_brutos.xlsx", sheet = "datos")
# A partir del 20 de Abril, usando datos de la Junta
# http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html

datos <- readr::read_csv2("datos/datos_provincias_raw.csv", 
                          col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE) %>%
  # select(-CODIGO_INE1, -CODIGO_INE2) %>% 
  filter(!is.na(Medida)) %>%
  mutate(Medida = ifelse(Medida == "Fallecidos", "Defunciones", Medida))

# datos %>%
#   assertr::verify(unique(.$Medida) == 
#                     c("Confirmados PCR", "Hospitalizados", "UCI", 
#                       "Curados", "Defunciones", "Total confirmados"))

datos <- datos %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
  rename(Fecha = `Fecha diagnóstico`, 
         ConfirmadosPCR = `Confirmados PDIA`, 
         ConfirmadosTotal = `Total confirmados`) %>%
  dplyr::select(Fecha, Territorio, ConfirmadosPCR, ConfirmadosTotal, everything()) %>%
  arrange(Fecha) %>%
  dplyr::filter(Territorio != "España")


write_csv(datos, "datos/datos_provincias_clean.csv")

```


```{r datos.provs, include=FALSE}
datos.provs <- datos %>%
  filter(Territorio != "Andalucía", Territorio != "Provincia sin especificar")

datos.provs %>%
  verify(length(unique(Territorio)) == 8, success_fun = success_logical)

```


```{r datos.andal}

## Datos test de Junta Andalucía
# test.andal <- readxl::read_excel("datos/test_Andalucia.xlsx")
# test.andal$Fecha <- as.Date(test.andal$Fecha)

datos.andal <- datos %>%
  filter(Territorio == "Andalucía") 
  # left_join(test.minist, by = "Fecha") 
  
```

```{r casos.edad.fecha}

library(stringr)

casos.edad.fecha <- read_csv2("datos/confPCR_edad_fecha.csv",
                          skip_empty_rows = TRUE) %>%
  select(`Fecha diagnóstico`, Edad, Valor) %>%
  filter(!is.na(Edad)) %>%
  tidyr::separate(col = "Fecha diagnóstico", into = c("Dia", "Mes", "Año"), sep = "/", remove = TRUE) %>%
  mutate(Fecha = paste(`Año`, Mes, Dia, sep = "-")) %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>%
  mutate(edades = factor(edades,
                         levels = rev(c("0 - 14", "15 - 29", "30 - 44", "45 - 64", "65 - 84", "85 y más")))) %>%
  rename(Casos = Valor) %>%
  mutate(Casos = ifelse(is.na(Casos), 0, Casos)) %>% 
  select(-Dia, -Mes) %>% 
  select(Fecha, everything()) 

## Nº de habitantes en cada categoria
# Datos de 2020 (https://www.juntadeandalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/21974?CodOper=b3_151&codConsulta=21974) 
nhab.edad.sexo <- data.frame(
  Edad = sort(unique(casos.edad.fecha$Edad)),
  nhab = c(
    1307411, #0-14
    1386604, #15-29
    1843446, #30-44
    2456137, #45-64
    1259766, #65-84 (estimado as Casos*100000 / Tasa)
    211048 #85+ (estimado as Casos*100000 / Tasa)
  )
)


casos.edad.fecha <- casos.edad.fecha %>% 
  left_join(nhab.edad.sexo, by = "Edad") %>% 
  group_by(Edad) %>% 
  arrange(Fecha) %>% 
  mutate(Casos.acum = cumsum(Casos)) %>% 
  mutate(Casos.14d = Casos.acum - lag(Casos.acum, n = 14),
         Casos.7d = Casos.acum - lag(Casos.acum, n = 7)) %>% 
  mutate(IA.14d = Casos.14d*100000 / nhab,
         IA.7d = Casos.7d*100000 / nhab) %>% 
  ungroup()

## incidencia acumulada >65 años

# Nº personas >=65 años: 1440102
# Datos de 2020 (https://www.juntadeandalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/21974?CodOper=b3_151&codConsulta=21974)

casos.65 <- casos.edad.fecha %>% 
  filter(Edad == "De 65 a 84 años" | Edad == "De 85 y más años") %>% 
  group_by(Fecha) %>% 
  # summarise(Casos = sum(Casos)) %>% 
  # mutate(Casos.acum = cumsum(Casos)) %>% 
  summarise(Casos.14d.65a = sum(Casos.14d),
         Casos.7d.65a = sum(Casos.7d)) %>% 
  mutate(Tasa.14d.65a = Casos.14d.65a * 100000 / 1470813,
         Tasa.7d.65a = Casos.7d.65a * 100000 / 1470813) %>% 
  mutate(Territorio = "Andalucía") 
  
  
```



```{r casos.edad.provs}

casos.edad.provs <- read_csv2("datos/casos_edad_provs.csv",
                              skip_empty_rows = TRUE) %>%
  select(`Lugar de residencia`:`Valor`) %>%
  filter(Sexo == "Ambos sexos") %>% 
  filter(!is.na(Edad)) %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>% 
  rename(Territorio = "Lugar de residencia",
         Casos.14d = `Confirmados PDIA 14 días`,
         Casos.7d = `Confirmados PDIA 7 días`,
         IA.14d = `Tasa PDIA 14 dias`,
         IA.7d = `Tasa PDIA 7 dias`)

ia.provs <- casos.edad.provs %>% 
  filter(Edad == "TOTAL")  
  

## Nº de habitantes en cada categoria
# Datos de 2020 (https://www.juntadeandalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/21974?CodOper=b3_151&codConsulta=21974)
nhab.provs <- read_csv("datos/Nhab_provincias.csv")

## IA mayores 65 años
ia.provs.65yr <- casos.edad.provs %>% 
  filter(Edad == "De 65 a 84 años" | Edad == "De 85 y más años") %>% 
  group_by(Territorio) %>% 
  summarise(Casos.14d.65yr = sum(Casos.14d),
            Casos.7d.65yr = sum(Casos.7d)) %>% 
  left_join(nhab.provs, by = "Territorio") %>% 
  mutate(IA.14d.65yr = round(100000*Casos.14d.65yr/Nhab.65yr),
         IA.7d.65yr = round(100000*Casos.7d.65yr/Nhab.65yr)) %>% 
  mutate(Tlevel = ifelse(Territorio == "Andalucía", 1, 2)) %>% 
  arrange(Tlevel)
  
```



```{r datos.acum}

datos.acum <- read_csv2("datos/acumulados.csv", 
                        col_types = "Dcci-",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = ".",
                                          date_format = "%d/%m/%Y"),
                          skip_empty_rows = TRUE) %>%
  filter(Medida != "Total confirmados") %>%
  mutate(Medida = stringr::str_replace_all(Medida, " PDIA", "")) %>% 
  mutate(Medida = stringr::str_replace_all(Medida, " días", "d")) %>% 
  mutate(Medida = ifelse(Medida == "Confirmados PCR", "ConfirmadosPCR", Medida),
         Medida = ifelse(Medida == "Total UCI", "UCI", Medida),
         Medida = ifelse(Medida == "Fallecidos", "Defunciones", Medida),
         Medida = ifelse(Medida == "Curados", "Recuperados", Medida)) %>%
  tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
  arrange(Fecha) %>% 
  left_join(nhab.provs, by = "Territorio") %>% 
  mutate(IA14 = round(100000*`Confirmados 14d` / Nhab.total),
         IA7 = round(100000*`Confirmados 7d` / Nhab.total)) 



## Add tasas mayores de 65 años
datos.acum <- datos.acum %>% 
  left_join(casos.65, by = c("Fecha", "Territorio"))


## Add datos positividad
# TODO 
# test.minist <- read_csv2("datos/datos_test_ministerio.csv",
#                          locale = locale(encoding = "ISO-8859-1")) %>%
#   filter(PROVINCIA %in% unique(datos.acum$Territorio)) %>%
#   mutate(Fecha = parse_date(FECHA_PRUEBA, format = "%d%b%Y",
#                             locale = locale(date_names = "en"))) %>% 
#   mutate(N.PCR.TA = N_ANT + N_PCR,
#          Positividad = 100*(N_ANT_POSITIVOS + N_PCR_POSITIVOS)/N.PCR.TA)



## Add datos posit + trazabilidad
trazab.minist <- readxl::read_excel("datos/positividad_Ministerio.xlsx") %>% 
  # select(Fecha, Territorio, Trazab_indic) %>% 
  mutate(Fecha = as.Date(Fecha))

datos.acum <- datos.acum %>% 
  full_join(trazab.minist, by = c("Fecha", "Territorio"))


# Add datos camas ocupadas
camas <- readxl::read_excel("datos/camas_ocupadas.xlsx") %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  rename(CamasUCI = UCI)

datos.acum <- datos.acum %>%
  left_join(camas, by = c("Fecha", "Territorio")) %>% 
  arrange(Fecha)

datos.acum.andal <- datos.acum %>% 
  filter(Territorio == "Andalucía")

```



```{r datos.diarios.iscii}

## Agrupar datos provinciales a nivel de Com Aut
datos.diarios.iscii <- read_csv("datos/casos_hosp_uci_def_sexo_edad_provres.csv") %>% 
  filter(provincia_iso %in% c("AL", "CA", "CO", "GR", "HU", "J", "MA", "SE")) %>% 
  group_by(sexo, grupo_edad, fecha) %>% 
  summarise(casos = sum(num_casos), hosp = sum(num_hosp), 
            uci = sum(num_uci), def = sum(num_def))

datos.diarios.iscii.notna <- datos.diarios.iscii %>% 
  filter(sexo != "NC") %>% 
  filter(grupo_edad != "NC")


## 2021-07-11: data from ISCII

casos.edad.fecha.iscii <- datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(casos = sum(casos),
            hosp = sum(hosp),
            uci = sum(uci),
            def = sum(def)) %>% 
  group_by(grupo_edad) %>%
  mutate(casos_ma = zoo::rollmean(casos, 7, fill = NA)) %>%
  ungroup()


## Numero habitantes calculated reversely from datos casos and IA from IECA
# see nhab_edades.xls
nhab.edad <- data.frame(
  grupo_edad = sort(unique(datos.diarios.iscii.notna$grupo_edad)),
  nhab = c(814255L, 951088L, 928672L, 1140217L, 1385114L, 1265021L, 916147L, 650381L, 413516L))


## Calculate IA
casos.edad.fecha.iscii <- casos.edad.fecha.iscii %>%
  left_join(nhab.edad, by = "grupo_edad") %>% 
  group_by(grupo_edad) %>% 
  arrange(fecha) %>% 
  mutate(Casos.acum = cumsum(casos)) %>% 
  mutate(Casos.14d = Casos.acum - lag(Casos.acum, n = 14),
         Casos.7d = Casos.acum - lag(Casos.acum, n = 7)) %>% 
  mutate(IA.14d = Casos.14d*100000 / nhab,
         IA.7d = Casos.7d*100000 / nhab) %>% 
  ungroup()

```


```{r datos.camas.minist}
datos.camas.minist <- read_csv2("datos/datos_camas_ministerio.csv", locale = locale(encoding = "latin1")) %>%
  filter(CCAA == "ANDALUCÍA") %>% 
  mutate(Fecha = as.Date(Fecha, format = "%d/%m/%Y")) %>% 
  assert(in_set("U. Críticas SIN respirador", "Hospitalización convencional", "U. Críticas CON respirador"), Unidad) %>% 
  mutate(tipo = ifelse(Unidad == "Hospitalización convencional", "Convencional", "UCI")) %>% 
  group_by(Fecha, Provincia, tipo) %>% 
  summarise(total = sum(TOTAL_CAMAS),
            covid = sum(OCUPADAS_COVID19),
            nocovid = sum(OCUPADAS_NO_COVID19)) %>% 
  tidyr::pivot_wider(names_from = "tipo", values_from = c("total", "covid", "nocovid")) %>% 
  ungroup() %>% 
  rename(Territorio = Provincia) %>% 
  mutate(Tlevel = 2)


datos.camas.minist.Andal <- datos.camas.minist %>% 
  group_by(Fecha) %>% 
  summarise(across(-Territorio, .fns = sum)) %>% 
  mutate(Territorio = "Andalucía",
         Tlevel = 1) %>% 
  relocate(Territorio, .after = Fecha)
  

datos.camas.minist <- datos.camas.minist %>% 
  bind_rows(datos.camas.minist.Andal) %>% 
  arrange(Fecha, Tlevel, Territorio) %>% 
  mutate(`%OcupHosp` = round(100*covid_Convencional/total_Convencional),
         `%OcupUCI` = round(100*covid_UCI/total_UCI))


datos.camas.minist.last.day <- datos.camas.minist %>% 
  filter(Fecha == max(Fecha))


```


```{r bg.color.funs}

indic.umbrales <- readxl::read_excel("datos/indicadores_umbrales.xlsx")

indic.color.riesgo <- Vectorize(function(value, umbrales.df = indic.umbrales) {

  color <- umbrales.df$Color[umbrales.df$Riesgo == value]
  
}, vectorize.args = "value")


indic.color.numeric <- function(vble, 
                                indic.df = datos.indic, 
                                umbrales.df = indic.umbrales) {
  
  if ("%OcupHosp" %in% names(indic.df)) {
    indic.df <- indic.df %>% 
      rename(CamasOcup = `%OcupHosp`, 
           UCI = `%OcupUCI`)
  }

  
  if (vble == "Trazabilidad") {
    umbrales.df <- arrange(umbrales.df, Trazabilidad)
  }
  intervalo <- findInterval(indic.df[[vble]], umbrales.df[[vble]])
  color <- umbrales.df$Color[intervalo]
  
}

```


```{r datos.last}

## Existen discordancias entre serie suministrada al ministerio y la depurada por la Junta a posteriori. 
## La de la Junta lleva mucho retraso últimamente. Paso a usar la del ministerio

# ## Usando la serie de la Junta (1 día de retraso)
# datos.last <- datos.andal %>%
#   dplyr::select(Fecha:Defunciones) %>%#
#   bind_rows(datos.provs) %>%
#   dplyr::select(-ConfirmadosTotal) %>%
#   filter(Fecha == max(Fecha)) %>%
#   mutate_at(3:ncol(.), function(x) {ifelse(is.na(x), 0, x)}) %>% 
#   rename(`Confirmados PCR/Antígeno` = ConfirmadosPCR)
# 
# 
# kable(datos.last[, -1])


ayer <- datos.acum %>% 
  group_by(Territorio) %>% 
  mutate(across(.cols = c(Confirmados, Hospitalizados:Recuperados), 
         .fns = function(x) {x - lag(x)})) %>% 
  mutate(Fecha.lag = Fecha - lag(Fecha)) %>% 
  ungroup()

last.day.valid <- ayer %>% 
  filter(Fecha.lag < 2) %>% 
  filter(Fecha == max(Fecha)) %>% 
  select(-Fecha.lag) %>% 
  # mutate(Tasa.14d = case_when(  # dividir por tamaño de población
  #   Territorio == "Andalucía" ~ 100000*`Confirmados 14d` / 8414240,
  #   Territorio == "Almería" ~ 100000*`Confirmados 14d` / 716820,
  #   Territorio == "Cádiz" ~ 100000*`Confirmados 14d` / 1240155,
  #   Territorio == "Córdoba" ~ 100000*`Confirmados 14d` / 786635,
  #   Territorio == "Granada" ~ 100000*`Confirmados 14d` / 914678,
  #   Territorio == "Huelva" ~ 100000*`Confirmados 14d` / 510743,
  #   Territorio == "Jaén" ~ 100000*`Confirmados 14d` / 633564,
  #   Territorio == "Málaga" ~ 100000*`Confirmados 14d` / 1661785,
  #   Territorio == "Sevilla" ~ 100000*`Confirmados 14d` / 1949860,
  # )) %>% 
  # mutate(Tasa.7d = case_when(  # dividir por tamaño de población
  #   Territorio == "Andalucía" ~ 100000*`Confirmados 7d` / 8414240,
  #   Territorio == "Almería" ~ 100000*`Confirmados 7d` / 716820,
  #   Territorio == "Cádiz" ~ 100000*`Confirmados 7d` / 1240155,
  #   Territorio == "Córdoba" ~ 100000*`Confirmados 7d` / 786635,
  #   Territorio == "Granada" ~ 100000*`Confirmados 7d` / 914678,
  #   Territorio == "Huelva" ~ 100000*`Confirmados 7d` / 510743,
  #   Territorio == "Jaén" ~ 100000*`Confirmados 7d` / 633564,
  #   Territorio == "Málaga" ~ 100000*`Confirmados 7d` / 1661785,
  #   Territorio == "Sevilla" ~ 100000*`Confirmados 7d` / 1949860,
  # )) %>% 
  # mutate(IA14 = round(Tasa.14d), IA7 = round(Tasa.7d)) %>% 
  mutate(IA14.col = indic.color.numeric("IA14", indic.df = .),
         IA7.col = indic.color.numeric("IA7", indic.df = .))
 
```

<br>


## Indicadores Ministerio Sanidad (semáforo) {#semaforo}

```{r indicadores.datos}

datos.indic <- readxl::read_excel("datos/indicadores_sanidad.xlsx") %>% 
  mutate(Fecha = as.Date(Fecha)) %>% 
  filter(Fecha == max(Fecha)) %>% 
  rename(`%OcupHosp` = CamasOcup, `%OcupUCI` = UCI)



## Update datos del informe de Sanidad con los últimos datos de la Junta
datos.indic <- datos.indic %>% 
  mutate(Fecha = last.day.valid$Fecha) %>% 
  mutate(IA14 = ia.provs$IA.14d,
         IA7 = ia.provs$IA.7d,
         IA14.65yr = ia.provs.65yr$IA.14d.65yr,
         IA7.65yr = ia.provs.65yr$IA.7d.65yr,
         `%OcupHosp` = datos.camas.minist.last.day$`%OcupHosp`,
         `%OcupUCI` = datos.camas.minist.last.day$`%OcupUCI`)
```

<br>

```{r indic.colors}

## Add colors to data table
datos.indic <- datos.indic %>% 
  mutate(
    # Riesgo.col = indic.color.riesgo(datos.indic$Riesgo),
         IA14.col = indic.color.numeric("IA14"),
         IA7.col = indic.color.numeric("IA7"),
         IA14.65yr.col = indic.color.numeric("IA14.65yr"),
         IA7.65yr.col = indic.color.numeric("IA7.65yr"),
         Positividad.col = indic.color.numeric("Positividad"),
         Trazabilidad.col = indic.color.numeric("Trazabilidad"),
         OcupHosp.col = indic.color.numeric("CamasOcup"),
         OcupUCI.col = indic.color.numeric("UCI")
         )

```


Las siguientes tablas y gráficas muestran la evolución de cada uno de los [indicadores](https://www.lamoncloa.gob.es/serviciosdeprensa/notasprensa/sanidad14/Documents/2020/221020_ActuacionesrespuestaCOVID.pdf) aprobados por el Consejo Interterritorial de Salud.

Los distintos colores representan [niveles crecientes de riesgo](https://twitter.com/DadosdeLaplace/status/1319326140671066113/photo/1), desde el **verde ("nueva normalidad") al morado ("riesgo extremo")**, pasando por amarillo (riesgo bajo), naranja (riesgo medio), y rojo (riesgo alto).

<br>


```{r indicadores.tabla, crop = TRUE}

library(flextable)

set_flextable_defaults(digits = 0, big.mark = ".", decimal.mark = ",")

datos.indic %>% 
  select(-Fecha, -Riesgo) %>% 
  select(Territorio, IA14:`%OcupUCI`) %>% 
  mutate(across(IA14:`%OcupUCI`, round)) %>% 
  flextable() %>% 
  # colformat_num(j = 3:10, digits = 0) %>% 
  # bg(j = "Riesgo", part = 'body', bg = indic.color.riesgo) %>% 
  bg(j = "IA14", bg = datos.indic$IA14.col) %>% 
  bg(j = "IA7", bg = datos.indic$IA7.col) %>%
  bg(j = "IA14.65yr", bg = datos.indic$IA14.65yr.col) %>% 
  bg(j = "IA7.65yr", bg = datos.indic$IA7.65yr.col) %>% 
  bg(j = "Positividad", bg = datos.indic$Positividad.col) %>% 
  bg(j = "Trazabilidad", bg = datos.indic$Trazabilidad.col) %>% 
  bg(j = "%OcupHosp", bg = datos.indic$OcupHosp.col) %>% 
  bg(j = "%OcupUCI", bg = datos.indic$OcupUCI.col) %>% 
  autofit() %>% 
  plot(zoom = 1)
  
```

Datos relativos al `r max(datos.acum$Fecha)`, salvo para 'Positividad' y 'Trazabilidad', que proceden del último [informe de indicadores](https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/situacionActual.htm?q=service/) del Ministerio de Sanidad. 

<br>



### Bloque 1: Nivel de Transmisión {#bloqueI}

<br>

```{r IA14, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(IA14))

ggplot(datos.plot) +
  geom_line(aes(Fecha, IA14), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha),
           y = datos.plot$IA14[nrow(datos.plot)],
           label = round(datos.plot$IA14[nrow(datos.plot)])) +
  # scale_y_continuous(sec.axis = dup_axis(
  #   breaks = datos.plot$IA14[nrow(datos.plot)],
  #   labels = round(datos.plot$IA14[nrow(datos.plot)]))) +
  scale_x_date(limits = c(as.Date("2021-01-01"), NA), 
               date_breaks = "1 month", date_labels = "%b") +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 25), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 50), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 150), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 150, ymax = 250), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 250, ymax = max(IA14)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 14 días",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```


```{r IA7, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(IA7)) 

ggplot(datos.plot) +
  geom_line(aes(Fecha, IA7), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha), 
           y = datos.plot$IA7[nrow(datos.plot)],
           label = round(datos.plot$IA7[nrow(datos.plot)])) +
  scale_x_date(limits = c(as.Date("2021-01-01"), NA), 
               date_breaks = "1 month", date_labels = "%b") +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 10), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 25), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 75), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 75, ymax = 125), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 125, ymax = max(IA7)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 7 días",
       subtitle = "Casos confirmados en los últimos 7 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```



```{r IA14.65a, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(Tasa.14d.65a)) 
  # filter(Fecha <= max(casos.edad.fecha$Fecha) - 1)

ggplot(datos.plot) +
  geom_line(aes(Fecha, Tasa.14d.65a), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha), 
           y = datos.plot$Tasa.14d.65a[nrow(datos.plot)],
           label = round(datos.plot$Tasa.14d.65a[nrow(datos.plot)])) +
  scale_x_date(limits = c(as.Date("2021-01-01"), NA), 
               date_breaks = "1 month", date_labels = "%b") +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 20), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 20, ymax = 50), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 100), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 100, ymax = 150), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 150, ymax = max(Tasa.14d.65a)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 14 días (> 65 años)",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes > 65 años",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```


```{r IA7.65a, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(Tasa.7d.65a)) 
  # filter(Fecha <= max(casos.edad.fecha$Fecha) - 1)

ggplot(datos.plot) +
  geom_line(aes(Fecha, Tasa.7d.65a), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha), 
           y = datos.plot$Tasa.7d.65a[nrow(datos.plot)],
           label = round(datos.plot$Tasa.7d.65a[nrow(datos.plot)])) +
  scale_x_date(limits = c(as.Date("2021-01-01"), NA), 
               date_breaks = "1 month", date_labels = "%b") +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 10), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 25), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 50), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 75), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 75, ymax = max(Tasa.7d.65a)), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Incidencia Acumulada 7 días (> 65 años)",
       subtitle = "Casos confirmados en los últimos 7 días por cada 100.000 habitantes > 65 años",
       caption = "https://tiny.cc/COVID19-Andalucia")
  
```



```{r Positividad, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(Positividad.7d)) %>% 
  filter(Fecha >= as.Date("2021-01-01"))

ggplot(datos.plot) +
  geom_line(aes(Fecha, Positividad.7d), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha), 
           y = datos.plot$Positividad.7d[nrow(datos.plot)],
           label = paste(round(datos.plot$Positividad.7d[nrow(datos.plot)]), "%", sep = " ")) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 4), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 4, ymax = 7), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 7, ymax = 10), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 15), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 15, ymax = 20), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Positividad de las PCR + Test Antígeno",
       subtitle = "% Positivos última semana",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")
  
```


```{r Ntest, fig.height=3}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(N.PCR.TA.7d))  %>% 
  filter(Fecha >= as.Date("2021-01-01"))

ggplot(datos.plot) +
  geom_line(aes(Fecha, N.PCR.TA.7d), size = 2) +
  annotate("text", x = 20 + max(datos.plot$Fecha), 
           y = datos.plot$N.PCR.TA.7d[nrow(datos.plot)],
           label = round(datos.plot$N.PCR.TA.7d[nrow(datos.plot)])) +
  labs(x = "", y = "",
       title = "Número de pruebas realizadas",
       subtitle = "Pruebas realizadas en la última semana (PCR + Test Antígeno)",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")
  
```


```{r Trazabilidad, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(Trazab_indic)) %>% 
  filter(Fecha >= as.Date("2021-01-01"))

ggplot(datos.plot) +
  geom_line(aes(Fecha, Trazab_indic), size = 2) +
  annotate("text", x = 12 + max(datos.plot$Fecha), 
           y = datos.plot$Trazab_indic[nrow(datos.plot)],
           label = paste(round(datos.plot$Trazab_indic[nrow(datos.plot)]), "%", sep = " ")) +
  geom_ribbon(aes(x = Fecha, ymin = 80, ymax = 100), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 65, ymax = 80), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 50, ymax = 65), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 30, ymax = 50), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 30), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Trazabilidad de los casos",
       subtitle = "% casos que son contactos de positivo conocido",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")
  
```

<br>

### Bloque 2: Capacidad Asistencial {#bloqueII}

<br>

```{r ocup.hospi, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(`%CamasOcup.Minist`)) %>% 
  filter(Fecha >= as.Date("2021-01-01"))

ggplot(datos.plot) +
  geom_line(aes(Fecha, `%CamasOcup.Minist`), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha), 
           y = datos.plot$`%CamasOcup.Minist`[nrow(datos.plot)],
           label = paste(round(datos.plot$`%CamasOcup.Minist`[nrow(datos.plot)]), "%", sep = " ")) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 2), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 2, ymax = 5), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 5, ymax = 10), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 15), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 15, ymax = 30), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Ocupación hospitalaria",
       subtitle = "% camas ocupadas por COVID-19",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")

```


```{r ocup.uci, fig.height=4}

datos.plot <- datos.acum.andal %>% 
  filter(!is.na(`%UCI.Minist`)) %>% 
  filter(Fecha >= as.Date("2021-01-01"))

ggplot(datos.plot) +
  geom_line(aes(Fecha, `%UCI.Minist`), size = 2) +
  annotate("text", x = 10 + max(datos.plot$Fecha), 
           y = datos.plot$`%UCI.Minist`[nrow(datos.plot)],
           label = paste(round(datos.plot$`%UCI.Minist`[nrow(datos.plot)]), "%", sep = " ")) +
  geom_ribbon(aes(x = Fecha, ymin = 0, ymax = 5), fill = "#4daf4a", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 5, ymax = 10), fill = "#ffff33", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 10, ymax = 15), fill = "#ff7f00", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 15, ymax = 25), fill = "#e41a1c", alpha = 0.3) +
  geom_ribbon(aes(x = Fecha, ymin = 25, ymax = 40), 
              fill = "#984ea3", alpha = 0.3) +
  labs(x = "", y = "",
       title = "Ocupación UCI",
       subtitle = "% camas UCI ocupadas por COVID-19",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")

```

<br>


### Camas ocupadas

<br>

El pico máximo de camas ocupadas de la "primera ola" se alcanzó el 30 de Marzo de 2020 con 2708 pacientes ingresados (438 en UCI). Ese número se rebasó el 2 de Noviembre (ya en la segunda ola) con 2764 personas ingresadas (381 en UCI). 

El pico de ingresados de la 2ª ola se alcanzó el 9 de Noviembre con 3478 personas ingresadas (460 en UCI). El 17 de Noviembre había 528 pacientes en UCI. 

El pico de ingresados de la 3ª ola se alcanzó el 2 de Febrero de 2021 con 4911 ingresados. El 6 de Febrero llegó a haber 735 pacientes ingresados en UCI. 

<br>

```{r camas.ocupadas, fig.height=4}

camas <- readxl::read_excel("datos/camas_ocupadas.xlsx") %>%
  mutate(Fecha = as.Date(Fecha)) %>%
  rename(CamasUCI = UCI)

camas.last <- camas %>%
  filter(!is.na(CamasOcup)) %>%
  slice_tail()

pico30Marzo <- data.frame(Fecha = as.Date("2020-03-30"), CamasOcup = 2708, CamasUCI = 438)

ggplot(camas) +
  geom_line(aes(Fecha, CamasOcup), colour = "#377eb8", size = 2) +
  geom_line(aes(Fecha, CamasUCI), colour = "#e41a1c", size = 2) +
  ylim(0, NA) +
  labs(title = "Pacientes ingresados con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia",
       x = "", y = "Camas ocupadas\n") +
  geom_point(data = pico30Marzo, aes(Fecha, CamasOcup), colour = "#377eb8", size = 2) +
  geom_point(data = pico30Marzo, aes(Fecha, CamasUCI), colour = "#e41a1c", size = 2) +
  annotate("text", x = max(camas.last$Fecha) + 5, y = camas.last$CamasOcup + 200, 
           label = paste0("Total ", camas.last$CamasOcup), colour = "#377eb8",
           hjust = 0) +
  annotate("text", x = max(camas.last$Fecha) + 5, y = camas.last$CamasUCI,
           label = paste0("UCI ", camas.last$CamasUCI), colour = "#e41a1c",
           hjust = 0) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b", 
               limits = c(as.Date("2020-04-05"), NA), 
               expand = expansion(add = c(10, 100))) 

camas %>% 
  filter(Fecha >= as.Date("2021-09-01")) %>% 
ggplot() +
  geom_line(aes(Fecha, CamasOcup), colour = "#377eb8", size = 2) +
  geom_line(aes(Fecha, CamasUCI), colour = "#e41a1c", size = 2) +
  ylim(0, NA) +
  labs(title = "\nPacientes ingresados con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia",
       x = "", y = "Camas ocupadas\n") +
  annotate("text", x = max(camas.last$Fecha) + 2, y = camas.last$CamasOcup, 
           label = paste0("Total ", camas.last$CamasOcup), colour = "#377eb8",
           hjust = 0) +
  annotate("text", x = max(camas.last$Fecha) + 2, y = camas.last$CamasUCI,
           label = paste0("UCI ", camas.last$CamasUCI), colour = "#e41a1c",
           hjust = 0) +
  scale_x_date(date_breaks = "1 week", date_labels = "%d %b", 
               expand = expansion(add = c(5, 12))) +
  theme(axis.text.x = element_text(size = 9))

```


<br>

## Vacunación {#vacunacion}

<br>

```{r datos.vacunas}
# datos de Datadista
datos.vacu <- read_csv("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_vacunas.csv", 
                        locale = locale(decimal_mark = ",", grouping_mark = "."), 
                       guess_max = 10000) %>% 
   filter(CCAA == "Andalucía") %>% 
  mutate(entregadas = ifelse(`Fecha publicación` < as.Date("2021-01-14"), `Dosis entregadas Pfizer`, `Dosis entregadas totales`)) %>% 
  mutate(`Personas con pauta completa` = ifelse(`Fecha publicación` < as.Date("2021-01-16"), 0, `Personas con pauta completa`)) %>% 
  mutate(personas1dosis = `Dosis administradas` - 2*`Personas con pauta completa`) %>% #NB: this won't work with single-dose vaccines 
  select(Fecha = `Fecha publicación`, entregadas, administradas = `Dosis administradas`, 
         personas1dosis, perscompletas = `Personas con pauta completa`) %>% 
  mutate(prop.poblacion = 100*perscompletas/8464411) 

```


```{r fig.vacunas.dosis, fig.height=4}
datos.vacu %>% 
  select(Fecha, entregadas, administradas) %>% 
  mutate(entregadas = entregadas/1000000,
         administradas = administradas/1000000) %>% 
  tidyr::pivot_longer(cols = c("entregadas", "administradas")) %>% 
ggplot() + 
  geom_line(aes(Fecha, value, colour = name), size = 2) +
  scale_colour_manual(values = c("Lime Green", "Dark Green"), name = "") +
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  scale_y_continuous(labels = scales::label_number(big.mark = ".", decimal.mark = ",")) +
  labs(x = "", y = "Nº dosis (millones)\n", 
       title = "Número de dosis entregadas y administradas", 
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "top")
```


```{r fig.vacunas.poblacion, fig.height=4}
ggplot(datos.vacu) + 
  geom_line(aes(Fecha, prop.poblacion), size = 2, colour = "Forest Green") +
  scale_y_continuous(sec.axis = sec_axis(trans = function(x) {round(x*8464411/100)}, 
                                         name = "Nº personas\n",
                                         labels = scales::label_number(big.mark = ".", decimal.mark = ",")),
                     labels = scales::label_number(big.mark = ".", decimal.mark = ",")) +
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  labs(x = "", y = "% población vacunada\n", 
       title = "Porcentaje de población vacunada", 
       subtitle = "Personas con vacunación completa",
       caption = "https://tiny.cc/COVID19-Andalucia") 
```


```{r vacu_edades, fig.height=4}
vacu.edades <- read_csv2("datos/vacu_edades.csv") %>% 
  select(Fecha, Edad, Valor) %>% 
  mutate(Fecha = as.Date(Fecha, format = "%d/%m/%Y")) %>% 
  mutate(edades = stringr::str_remove_all(Edad, "De ")) %>% 
  mutate(edades = stringr::str_remove_all(edades, " años"))

ggplot(vacu.edades) +
  geom_line(aes(Fecha, Valor, colour = edades), size = 1.5) +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  labs(x = "", y = "", 
       title = "Porcentaje de vacunados con pauta completa",
       caption = "https://tiny.cc/COVID19-Andalucia")
```


<br>

[Aquí](https://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/vacunas-COVID19.html) hay mucha más información sobre el estado de la vacunación en Andalucía.

<br>


## Resumen de casos, ingresos y defunciones {#resumen}

<br>

```{r fig.resumen, out.width='100%', fig.height=6}

datos.andal.long <- datos.andal %>%
  select(Fecha, Territorio, ConfirmadosPCR, Hospitalizados, UCI, Defunciones) %>%
  tidyr::pivot_longer(cols = ConfirmadosPCR:Defunciones, names_to = "indic") %>%
  filter(indic != "Curados") %>%
  mutate(indic = ifelse(indic == "Hospitalizados", "Hospitalizaciones", indic)) %>%
  mutate(indic = ifelse(indic == "UCI", "Ingresos UCI", indic)) %>%
  mutate(indic = ifelse(indic == "ConfirmadosPCR", "Casos confirmados", indic)) %>%
  # mutate(indic = ifelse(indic == "CamasOcup", "Camas ocupadas", indic)) %>%
  mutate(indic = factor(indic, 
                        levels = c("Casos confirmados", "Hospitalizaciones", 
                                   "Ingresos UCI", "Defunciones"))) %>% 
  mutate(Fecha = as.Date(Fecha))

datos.andal.long %>% 
  group_by(indic) %>% 
  mutate(value_ma = zoo::rollmean(value, 7, fill = NA)) %>%  # 7-day moving average
  ungroup() %>% 
ggplot() +
  facet_wrap(~indic, ncol = 1, scales = "free_y") + 
  geom_col(aes(x = Fecha, y = value, fill = indic), alpha = 0.3) +
  geom_line(aes(x = Fecha, y = value_ma, colour = indic), size = 1.5) +
  scale_fill_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  scale_colour_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  labs(x = "", y = "Nº personas", caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b",
               limits = c(as.Date("2020-03-01"), max(datos.andal.long$Fecha) - 5)) +
  scale_y_continuous(sec.axis = dup_axis(name = "")) +
  theme(axis.text.x = element_text(size = 8))

```

<br>

Evolución en las **últimas cuatro semanas**:

```{r fig.resumen.14d, fig.height=6}

datos.andal.long %>%
  filter(Fecha > max(datos.andal.long$Fecha) - 28) %>%
ggplot() +
  facet_wrap(~indic, ncol = 1, scales = "free_y") + 
  geom_col(aes(x = Fecha, y = value, fill = indic)) +
  scale_fill_manual(values = c("#ff7f00", "#377eb8", "#e41a1c", "grey40")) +
  labs(x = "", y = "Nº personas\n", caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "7 days", date_labels = "%d %b") +
  scale_y_continuous(sec.axis = dup_axis(name = ""))

```

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. A menudo, en los días siguientes se añaden nuevos casos, ingresos y defunciones asignados a fechas pasadas. Por tanto, un descenso en, por ejemplo, el número de casos u hospitalizaciones en los últimos días **no debe interpretarse como un descenso** en la intensidad de la pandemia hasta que los datos sean consolidados en los próximos días.

<br>






```{r tabla.datos.dia, out.width='100%', crop = TRUE, eval=FALSE}

# **DATOS DEL DÍA:** `r unique(last.day.valid$Fecha) - 1`


last.day.valid %>% 
  select(Territorio, Casos = Confirmados, 
         Casos.14d = `Confirmados 14d`, IA.14d = IA14,
         Casos.7d = `Confirmados 7d`, IA.7d = IA7,
         Ingresos = Hospitalizados, UCI, Defunciones) %>% 
  flextable() %>% 
  bg(j = "IA.14d", bg = last.day.valid$IA14.col) %>% 
  bg(j = "IA.7d", bg = last.day.valid$IA7.col) %>% 
  autofit() %>% 
  plot(zoom = 1)

```

<br>



**DATOS ACUMULADOS:**

```{r datos.acum.tabla, out.width='80%', crop = TRUE, fig.align='center'}
# Estos datos normalmente un día por delante de la serie de la Junta

datos.acum %>%
  filter(Fecha == max(Fecha)) %>%
  select(Territorio, Casos = Confirmados, 
         #Casos.14d = `Confirmados 14d`, Casos.7d = `Confirmados 7d`, 
         Ingresos = Hospitalizados, UCI, Defunciones) %>% 
  flextable() %>% 
  width(width = 1.4) %>% 
  plot(zoom = 1)

```

<br>



## Casos confirmados

<br>

En primer lugar se muestra el número de casos confirmados diariamente mediante PCR o test rápido de antígeno (Pruebas Diagnósticas de Infección Activa). 

<br>

```{r casos.pcr.datadista, fig.height=4, out.width='100%', eval=FALSE}

download.file("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_datos_isciii.csv", destfile = "datos/datadista_ccaa_covid19_datos_isciii.csv")

casos.pcr <- readr::read_csv("datos/datadista_ccaa_covid19_datos_isciii.csv", guess_max = 10000) %>%
  dplyr::filter(CCAA == "Andalucía") %>%
  rename(PCR = `PCR+`, TestAc = `TestAc+`) %>%
  mutate(Casos = ifelse(is.na(Casos), PCR + TestAc, Casos)) %>%
  mutate(PCR = ifelse(is.na(PCR), Casos, PCR)) %>% # assuming before 14 Abril all/most cases were PCR, no TestAc
  mutate(PCR.new = PCR - lag(PCR))
  

ggplot(casos.pcr) +
  geom_col(aes(x = Fecha, y = PCR.new), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente por PCR en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```



```{r casos.pcr, fig.height=4, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00", alpha = 0.25) +
  geom_line(aes(x = Fecha, y = zoo::rollmean(ConfirmadosPCR, 7, fill = NA)), 
            colour = "#ff7f00", size = 1.5) +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = "")) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5))) +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.andal$Fecha) - 5), 
               date_breaks = "1 month", date_labels = "%b") +
  theme(axis.text.x = element_text(size = 8))

```

<br>

Debe tenerse en cuenta que el [número de casos confirmados depende en gran medida del número de test realizados](https://ourworldindata.org/covid-testing). Por tanto, un aumento o disminución en el número de casos confirmados puede deberse a haber realizado más o menos tests, no a variaciones en la incidencia de la enfermedad. 

Durante los primeros meses de la pandemia (Marzo-Mayo 2020) solo se realizó PCR a los pacientes más graves, dejando sin detectar probablemente [más del 90% de los casos](https://www.eldiario.es/sociedad/porcentaje-poblacion-contagiada-explosivo-COVID-19_0_1026798481.html), por lo que el número de casos diarios no es comparable entre periodos con distinta intensidad de muestreo como la primavera y el otoño. 


<br>

Casos confirmados por PCR o test de antígeno en los últimos 14 días:

<br>

```{r casos.pcr.14d, fig.height=4, out.width='100%'}

datos.andal %>%
  filter(Fecha > max(datos.andal$Fecha) - 14) %>%
ggplot() +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5))) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d %b") +
  geom_text(aes(Fecha, y = ConfirmadosPCR + 50, label = ConfirmadosPCR),
            data = subset(datos.andal, Fecha > max(datos.andal$Fecha) - 14), size = 3) 

```

<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevos casos asignados a fechas pasadas. Por tanto, **un descenso en el número de casos en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.

<br>

```{r casos_Andalucia, fig.height=4, out.width='100%', eval = FALSE}

# Además de PCR, la Junta de Andalucía está realizando test rápidos, que sirven para detectar personas que han sido probablemente contagiadas por el virus (aunque actualmente puedan no mostrar síntomas o no tener carga viral significativa). Las gráficas de abajo incluyen tanto los casos detectados mediante PCR como mediante test serológicos (anticuerpos).
# 
# <br>


ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = ConfirmadosTotal), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = Ntest.dia), 
            size = 1, colour = "grey70") + 
  scale_y_continuous(limits = c(0, NA), n.breaks = 6) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos de COVID-19 confirmados diariamente en Andalucía",
       subtitle = "La línea gris representa el número de test (PCR + serológicos) realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(panel.grid.minor.y = element_line(size = rel(0.5)))

```


```{r ncasos.ntest, out.width='100%', fig.height=4, eval=FALSE}

## NB: algún día (ej. 4 Mayo hay más confirmados que test!)

ggplot(datos.andal) +
  geom_point(aes(Ntest.dia, ConfirmadosTotal), 
             size = 3, colour = "#ff7f00") +
  scale_y_continuous(limits = c(0, NA), 
                     name = "Número de casos confirmados\n") +
  scale_x_continuous(limits = c(0, NA),
                     name = "\nNúmero de test realizados") +
  labs(title = "Relación entre el número de casos confirmados\ny el número de test realizados diariamente",
       caption = "https://tiny.cc/COVID19-Andalucia")
```


```{r prop.positivos, fig.height=4, out.width = '100%', eval=FALSE}

# La proporción de casos positivos respecto al total de test realizados también [puede informarnos](https://www.theatlantic.com/technology/archive/2020/04/us-coronavirus-outbreak-out-control-test-positivity-rate/610132/) sobre la incidencia de la enfermedad. 
# 
# <br>
  
  
sec.axis.factor = 30

ggplot(datos.andal) +
  # geom_ribbon(aes(x = Fecha, ymin = prop.ci.low, ymax = prop.ci.up),
  #             fill = "#ff7f00", alpha = 0.3) +
  geom_col(aes(x = Fecha, y = Prop.Positivos), 
            fill = "#ff7f00") +
  geom_line(aes(x = Fecha, y = (Ntest.dia/sec.axis.factor)), 
            colour = "grey70", size = 1.5) +
  # geom_text(aes(x = Fecha, y = 5, label = Ntest.dia), 
  #           colour = "#ff7f00", alpha = 0.8) +
  scale_y_continuous(limits = c(0, 100), 
                     sec.axis = sec_axis(trans = ~ ((.*sec.axis.factor)), 
                                         breaks = seq(0, 3000, by = 500),
                                         name = "Número de test\n")) +
  scale_x_date(limits = c(as.Date("2020-03-26"), as.Date("2020-05-13"))) +
  labs(x = "", y = "Porcentaje de tests positivos\n",
       title = "Porcentaje de tests que dan positivo en Andalucía",
       subtitle = "La línea gris representa el número de test realizados diariamente (eje derecho)",
       caption = "https://tiny.cc/COVID19-Andalucia")


# (La Junta de Andalucía ha dejado de proporcionar datos diarios del número de personas testadas, por lo que esta gráfica ha dejado de actualizarse desde el 12 de Mayo)

```


<br>

A continuación se presentan los **casos confirmados mediante PCR o test de antígeno en cada provincia**:

<br>

```{r casos_provincias, out.width = '100%', fig.height=6}

datos.provs %>% 
  group_by(Territorio) %>% 
  mutate(Conf_ma = zoo::rollmean(ConfirmadosPCR, 7, fill = NA)) %>% 
  ungroup() %>% 
ggplot() +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00", alpha = 0.2) +
  geom_line(aes(x = Fecha, y = Conf_ma),
            colour = "#ff7f00", size = 1) +
  ylim(0, NA) +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8),
        plot.subtitle = element_text(size = 9),
        axis.text.y = element_text(size = 10)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.provs$Fecha) - 5))

```


<br>

Y en los últimos 14 días:

<br>

```{r casos_provincias.14d, out.width = '100%', fig.height=6}

datos.provs %>%
  filter(Fecha > as.Date(Sys.Date() - 16)) %>%
ggplot() +
  facet_wrap(~Territorio, ncol = 2) +
  geom_col(aes(x = Fecha, y = ConfirmadosPCR), 
            fill = "#ff7f00") +
  labs(x = "", y = "Nuevas detecciones\n",
       title = "Casos diarios de COVID-19 en cada provincia",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(date_breaks = "4 days", date_labels = "%d %b") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = ""))

```

<br>


## Movilidad

Variación de la movilidad según los [datos de Google](https://www.google.com/covid19/mobility/). Estos datos comparan el número de visitas o tiempo empleado en distintos lugares en relación a la mediana del mismo día de la semana en el período comprendido entre el 3 de enero y el 6 de febrero de 2020 (período de referencia).


```{r mobidata}
if (! file.exists("datos/2021_ES_Region_Mobility_Report.csv")) {
  unzip("datos/Region_Mobility_Report_CSVs.zip", 
        files = "2021_ES_Region_Mobility_Report.csv", 
        exdir = "datos")
}

mobidata <- read_csv("datos/2021_ES_Region_Mobility_Report.csv") %>% 
  filter(sub_region_1 == "Andalusia") %>% 
  select(-"grocery_and_pharmacy_percent_change_from_baseline") %>% 
  rename("tiendas y ocio" = "retail_and_recreation_percent_change_from_baseline",
         "parques y playas" = "parks_percent_change_from_baseline",
         "transporte público" = "transit_stations_percent_change_from_baseline",
         "trabajo" = "workplaces_percent_change_from_baseline",
         "residencial" = "residential_percent_change_from_baseline") %>% 
  tidyr::pivot_longer(cols = starts_with("tiendas"):starts_with("residencial"), 
               names_to = "place", values_to = "change")

# library(directlabels)
library(ggrepel)

```

<br>

```{r mobi.andal}

mobidt <- mobidata %>% 
  filter(is.na(sub_region_2)) %>% 
  group_by(place) %>% 
  mutate(change_ma = zoo::rollmean(change, k = 30, fill = NA)) %>% 
  ungroup() %>% 
  filter(date > as.Date("2021-01-06"))

ggplot(mobidt) +
  aes(x = date, y = change_ma) +
  geom_line(aes(colour = place), size = 1.5) + 
  scale_colour_manual(values = c("#4DAF4A", "#984EA3", "#E41A1C", "#377EB8", "#999999"),
                      name = "", ) +
  geom_hline(yintercept = 0, colour = "black", size = 1, lty = 2) +
  labs(x = "", y = "Diferencia en la movilidad (%)\n",
       title = "Cambios en la movilidad (Andalucía)",
       subtitle = "Medias móviles mensuales de la diferencia en uso del espacio\nrespecto a la mediana diaria del periodo 3 Ene - 6 Feb 2020",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "none") +
  # geom_dl(aes(label = paste("", place), colour = place), method = "last.points",
  #         size = 2) +
  geom_text_repel(data = mobidt %>% filter(!is.na(change_ma)) %>% filter(date == max(date)), 
                  mapping = aes(x = date, y = change_ma, 
                                label = place, colour = place),
                  min.segment.length = 0,
                  nudge_x = 2) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b", 
               expand = expansion(add = c(0, 30)))

```

<br>

```{r mobi.provs, fig.height=10}

mobidata %>% 
  filter(!is.na(sub_region_2)) %>% 
  group_by(sub_region_2, place) %>% 
  mutate(change_ma = zoo::rollmean(change, k = 30, fill = NA)) %>% 
  ungroup() %>% 
  filter(date > as.Date("2021-01-06")) %>% 
  ggplot() +
  facet_wrap(~sub_region_2, ncol = 2) +
  aes(x = date, y = change_ma) +
  geom_line(aes(colour = place), size = 1) + 
  scale_colour_manual(values = c("#4DAF4A", "#984EA3", "#E41A1C", "#377EB8", "#999999"),
                      name = "", ) +
  geom_hline(yintercept = 0, colour = "black", size = 1, lty = 2) +
  labs(x = "", y = "Diferencia en la movilidad (%)\n",
       title = "Cambios en la movilidad (provincias)",
       subtitle = "Medias móviles mensuales de la diferencia en uso del espacio\nrespecto a la mediana diaria del período 3 Ene - 6 Feb 2020",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "top", legend.text = element_text(size = 9)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")

```

<br>

## Datos por Municipio

<br>

Consulta https://www.mapacovid.es para conocer el nivel de alerta y restricciones oficiales por municipio. 



```{r muni.pop}

library(sf)

muni.data <- readr::read_csv("datos/municipios.csv", guess_max = 200000) %>%
  filter(Fecha == max(Fecha)) %>%
  rename(PROVINCIA = Provincia, MUNICIPIO = Municipio) %>%
  mutate(CASOS.14d = ifelse(Confirmados.PCR.TA.14d < 1, NA, as.integer(Confirmados.PCR.TA.14d))) %>% 
  mutate(IA.14d = round(Conf14d_100.000hab))

Andal.border <- st_read("datos/Andalucia_contorno.gpkg", quiet = TRUE)

# muni.gpkg <- st_read("datos/municipios.gpkg", 
#                      stringsAsFactors = FALSE, quiet = TRUE) 
# 
# muni.lite <- rmapshaper::ms_simplify(muni.gpkg, keep_shapes = TRUE, keep = 0.01)
# 
# st_write(muni.lite, "datos/municipios_lite.gpkg")

muni.lite <- st_read("datos/municipios_lite.gpkg", 
                     stringsAsFactors = FALSE, quiet = TRUE)


muni.14d <- left_join(select(muni.lite, PROVINCIA, MUNICIPIO),
                      select(muni.data, PROVINCIA, MUNICIPIO, CASOS.14d),
                      by = c("PROVINCIA", "MUNICIPIO")) %>%
  mutate(casos = ifelse(is.na(CASOS.14d), 0, CASOS.14d),
         lab = paste(MUNICIPIO, casos, sep = ": "))


muni.dia <- readr::read_csv2("datos/municipios.dia/Municipios_todos_datoshoy.csv", col_types = "ccd_")

muni.dia <- muni.dia %>%
    rename(Municipio = `Lugar de residencia`) %>%
    dplyr::filter(!is.na(Municipio), Municipio %in% unique(muni.data$MUNICIPIO)) %>%
    dplyr::filter(!is.na(Medida)) %>%
    dplyr::filter(Medida == "Población" | Medida == "Confirmados PDIA" | 
                    Medida == "Tasa PDIA 14 dias" |
                    Medida == "Total Confirmados" | Medida == "Fallecidos") %>%
    mutate(rownumber = 1:nrow(.)) %>%
    group_by(Municipio) %>%
    arrange(rownumber) %>%
    slice_tail(n = 5) %>%
    ungroup() %>%
    select(-rownumber) %>%
    tidyr::pivot_wider(names_from = "Medida", values_from = "Valor") %>%
    mutate(Prop.Casos.Pop = 100*`Total Confirmados`/`Población`,
           Prop.Def.Pop = 100*Fallecidos/`Población`,
           Prop.Def.Casos = 100*Fallecidos/`Total Confirmados`) %>% 
    rename(MUNICIPIO = Municipio)

muni.dia <- left_join(muni.lite, muni.dia, by = "MUNICIPIO") 


muni.pop <- muni.dia %>% 
  # sf::st_drop_geometry() %>%
  select(Provincia = PROVINCIA, Municipio = MUNICIPIO, Poblacion = `Población`)

muni.todo <- readr::read_csv("datos/municipios.csv", guess_max = 200000) %>%
  mutate(IA.14d = round(Conf14d_100.000hab)) %>% 
  padr::pad(interval = "day", group = c("Provincia", "Distrito", "Municipio")) %>% 
  group_by(Provincia, Distrito, Municipio) %>% 
  mutate(IA.14d.prev = lag(IA.14d, n = 14)) %>% 
  mutate(IA.14d.prev = ifelse(IA.14d.prev == 0, NA, IA.14d.prev)) %>% 
  mutate(IA.cambio = round(100*(IA.14d - IA.14d.prev)/IA.14d.prev)) %>% 
  left_join(muni.pop) %>% 
  ungroup()

```



En esta figura interactiva se muestra la **incidencia acumulada a 14 días (IA) en cada municipio de >5.000 habitantes** en Andalucía, y el **cambio (en %) que dicho valor de IA representa respecto a la IA de catorce días previos**. Cambios negativos implican un descenso de la IA en las últimas dos semanas, y cambios positivos implican aumentos de la IA. Por ejemplo, un cambio del 100% significa que la IA se ha duplicado (ha aumentado un 100%) en las últimas dos semanas. Se excluyen de la gráfica valores de IA > 1000 y cambios en la IA > 500%. Pase el cursor sobre los puntos para ver el nombre del municipio.

<br>

```{r muni.ia.cambio}

library(ggiraph)

ia.cambio <- muni.todo %>% 
  filter(Fecha == max(Fecha)) %>% 
  filter(Poblacion > 5000) %>% 
  filter(IA.14d < 1000, IA.cambio < 500) %>%
  ggplot() +
  geom_point_interactive(aes(x = IA.14d, y = IA.cambio, 
                             tooltip = Municipio,
                             colour = Provincia)) +
  geom_hline(yintercept = 0) +
  scale_color_viridis_d_interactive() +
  # scale_color_brewer(type = "qual", palette = "Accent") +
  labs(title = "Tendencias en Incidencia Acumulada por Municipio",
       subtitle = "Cambio en la IA por municipio respecto a la IA en los 14 días previos\n",
       caption = "https://tiny.cc/COVID19-Andalucia",
       x = "\nIA actual",
       y = "Cambio en la IA respecto a los 14 días previos\n") +
  theme(plot.title = element_text(size = rel(0.9)),
        plot.subtitle = element_text(size = rel(0.7)),
        axis.title = element_text(size = rel(0.8)),
        legend.position = "top", legend.title = element_blank())
  
girafe(ggobj = ia.cambio)

```

<br>

En esta gráfica animada e interactiva se puede examinar con más detalle la **evolución de la Incidencia Acumulada en municipios de > 5.000 habitantes** en las últimas semanas. Pulsando sobre los nombres de provincia en la leyenda de la derecha se pueden resaltar/desactivar los municipios de cada provincia.

<br>

```{r muni.ia.cambio.anim}
library(plotly)

fig <- muni.todo %>%
  filter(Fecha > as.Date(max(muni.todo$Fecha) - 30)) %>% 
  filter(Poblacion > 5000) %>% 
  filter(IA.14d < 1000, IA.cambio < 500) %>%
  mutate(fecha = format(Fecha, "%m/%d")) %>%
  select(fecha, IA.14d, IA.cambio, Provincia, Municipio) %>% 
  plot_ly(
    x = ~IA.14d, 
    y = ~IA.cambio, 
    ids = ~Municipio,
    size = 1,
    color = ~Provincia, 
    frame = ~fecha, 
    text = ~Municipio, 
    hoverinfo = "text",
    type = 'scatter',
    mode = 'markers'
  ) %>% 
  layout(
    xaxis = list(title = "IA", tickfont = list(size = 15)),
    yaxis = list(title = "Cambio en la IA respecto a los 14 días previos", 
                 tickfont = list(size = 15))
  ) %>%
  animation_opts(
    1000, redraw = FALSE
  ) %>% 
  animation_button(
    x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  ) %>% 
  animation_slider(
    currentvalue = list(font = list(color = "black"))
  )

fig
```

<br>

### Mapas


Este mapa de **casos confirmados por PCR o test de antígeno en los últimos 14 días** es útil para saber dónde se encuentran los brotes activos en la actualidad. Pasa el cursor sobre el mapa para ver los valores concretos por municipio.

```{r mapamunis_PCR_14d, out.width='100%'}

library(ggiraph)

mapa <- 
  ggplot(muni.14d) +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.3) +
  ggiraph::geom_sf_interactive(aes(fill = CASOS.14d, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Casos confirmados en cada municipio",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```


**MUNICIPIOS CON MAYOR NÚMERO DE CASOS DETECTADOS (últimos 14 días)**

Se muestran los casos totales y la incidencia acumulada (casos por 100.000 habitantes en los últimos 14 días).

Datos correspondientes al `r max(muni.data$Fecha)`:

<br>

```{r}
muni.data %>% 
  arrange(desc(CASOS.14d)) %>%
  select(PROVINCIA, MUNICIPIO, CASOS.14d, IA.14d) %>% 
  head(20) %>% 
  flextable() %>% 
  width(j = "MUNICIPIO", width = 2.5)
```


<br>

Este mapa muestra la Incidencia Acumulada (casos confirmados por PCR o test de antígeno en los últimos 14 días **por cada 100.000 habitantes**):

```{r mapamunis_PCR_14d_hab, out.width='100%'}

muni.14d.hab <- left_join(select(muni.lite, PROVINCIA, MUNICIPIO),
                      select(muni.data, PROVINCIA, MUNICIPIO, IA.14d),
                      by = c("PROVINCIA", "MUNICIPIO")) %>%
  mutate(casos = ifelse(is.na(IA.14d), 0, round(IA.14d)),
         lab = paste(MUNICIPIO, casos, sep = ": "),
         casos = ifelse(IA.14d < 1, NA, casos))

mapa <- 
  ggplot(muni.14d.hab) +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.3) +
  ggiraph::geom_sf_interactive(aes(fill = casos, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Incidencia Acumulada en cada municipio",
       subtitle = "Casos por 100.000 habitantes en los últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```




```{r mapamunis_IA500, out.width='100%'}

mapa <- muni.14d.hab %>% 
  filter(casos > 500) %>% 
  ggplot() +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.3) +
  ggiraph::geom_sf_interactive(aes(fill = casos, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Municipios con Incidencia Acumulada >500",
       subtitle = ">500 casos por 100.000 habitantes en los últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```



```{r mapamunis_IA1000, out.width='100%'}

mapa <- muni.14d.hab %>% 
  filter(casos > 1000) %>% 
  ggplot() +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.3) +
  ggiraph::geom_sf_interactive(aes(fill = casos, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Municipios con Incidencia Acumulada >1000",
       subtitle = ">1000 casos por 100.000 habitantes en los últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```




```{r biscalemap, eval=FALSE}
library(biscale)
library(cowplot)


ia.cambio.sf <- muni.todo %>% 
  sf::st_set_geometry(muni.todo$geom) %>% 
  filter(Fecha == max(Fecha)) %>%
  mutate(IA.14d.prev = ifelse(is.na(IA.14d.prev), 1, IA.14d.prev)) %>% 
  mutate(IA.cambio = round(100*(IA.14d - IA.14d.prev)/IA.14d.prev)) %>% 
  bi_class(x = IA.14d, y = IA.cambio, dim = 3, style = "quantile")
  
map <- ggplot() +
  geom_sf(data = ia.cambio.sf, aes(fill = bi_class), 
          size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet", dim = 3, na.value = "white") +
  bi_theme() +
  theme(
    plot.title = element_text(size = 18),
    plot.caption = element_text(size = 8, hjust = 0.7, 
                                    face = "italic", colour = "grey60")) +
  labs(title = "Incidencia Acumulada actual y tasa de cambio", 
       caption = "https://tiny.cc/COVID19-Andalucia")

legend <- bi_legend(pal = "DkViolet",
                    dim = 3,
                    xlab = "Mayor IA",
                    ylab = "Mayor Aumento IA",
                    size = 8)

finalPlot <- ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(legend, 0.02, 0.2, 0.2, 0.2)

finalPlot
```




**MUNICIPIOS CON MAYOR INCIDENCIA ACUMULADA**

Se muestran los casos totales y la incidencia acumulada (casos por 100.000 habitantes en los últimos 14 días). Nótese que, en municipios pequeños, un número pequeño de casos puede dar lugar a valores de incidencia acumulada (casos por 100.000 habitantes) muy altos. 

Datos correspondientes al `r max(muni.data$Fecha)`:

<br>

```{r}
muni.data %>% 
  arrange(desc(Conf14d_100.000hab)) %>%
  select(PROVINCIA, MUNICIPIO, IA.14d, CASOS.14d) %>% 
  head(20) %>% 
  flextable() %>% 
  width(j = "MUNICIPIO", width = 2.5)
```

<br>




```{r mapamunis_propcasos}
mapa <- muni.dia %>% 
  mutate(lab = paste0(MUNICIPIO, ": ", round(Prop.Casos.Pop), "%")) %>% 
  ggplot() +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.1) +
  ggiraph::geom_sf_interactive(aes(fill = Prop.Casos.Pop, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Oranges", direction = 1, 
                       na.value = "white") +
  #theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Porcentaje de población contagiada por municipio",
       subtitle = "Desde el inicio de la pandemia.\nEste mapa solo tiene en cuenta los casos detectados oficialmente.\nEl porcentaje real de personas contagiadas podría ser muy superior",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```



```{r mapamunis_propdef}
mapa <- muni.dia %>% 
  mutate(lab = paste0(MUNICIPIO, ": ", round(Prop.Def.Pop, digits = 1), "%")) %>% 
  ggplot() +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.1) +
  ggiraph::geom_sf_interactive(aes(fill = Prop.Def.Pop, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_gradient(low = "white", high = "black", na.value = "white") +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Porcentaje de población fallecida por municipio",
       subtitle = "Este mapa solo tiene en cuenta los fallecimientos oficiales por COVID",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```

```{r mapamunis_pop}
mapa <- muni.dia %>% 
  mutate(lab = paste0(MUNICIPIO, ": ", round(`Población`))) %>% 
  ggplot() +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.1) +
  ggiraph::geom_sf_interactive(aes(fill = `Población`, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Purples", direction = 1,
                       na.value = "white",
                       labels = scales::label_number(big.mark = ".", decimal.mark = ",")) +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Número de habitantes por municipio",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```



```{r mapavacu}

vacu.muni <- read_csv2("datos/municipios.dia/vacu_muni.csv") %>% 
  filter(Edad == "TOTAL", Medida == "% Personas", Territorio != "Provincia sin especificar") %>% 
  select(MUNICIPIO = Territorio, Prop.vacu = Valor) %>% 
  mutate(Prop.vacu = stringr::str_replace_all(Prop.vacu, ",", ".")) %>% 
  mutate(Prop.vacu = as.numeric(Prop.vacu))

mapa <- muni.dia %>% 
  left_join(vacu.muni, by = "MUNICIPIO") %>% 
  mutate(lab = paste0(MUNICIPIO, ": ", round(Prop.vacu))) %>% 
  ggplot() +
  geom_sf(data = Andal.border, fill = NA, colour = "grey75", size = 0.1) +
  ggiraph::geom_sf_interactive(aes(fill = Prop.vacu, tooltip = lab), 
                               colour = "grey85", size = 0.1) +
  scale_fill_distiller(type = "seq", palette = "Greens", direction = 1,
                       na.value = "white",
                       labels = scales::label_number(big.mark = ".", decimal.mark = ",")) +
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Porcentaje de población vacunada",
       subtitle = "Porcentaje de población vacunada con pauta completa\nrespecto al número de habitantes censado a 1 de enero de 2020",
       caption = "https://tiny.cc/COVID19-Andalucia")

girafe(ggobj = mapa)

```



### Tabla interactiva de municipios

<br>
Esta tabla contiene los datos de **casos confirmados, incidencia acumulada y defunciones** acumuladas **por municipio**. Se pueden realizar búsquedas en toda la tabla o filtrar valores en cada columna.

Datos correspondientes al `r max(muni.data$Fecha)`.

<br>


```{r tabla.muni, out.width='100%'}

muni.dt <- readr::read_csv("datos/municipios.csv", guess_max = 200000) %>%
  filter(Fecha == max(Fecha)) %>%
  select(PROVINCIA = Provincia, MUNICIPIO = Municipio,
         IA.14d = Conf14d_100.000hab, CASOS.14d = Confirmados.PCR.TA.14d,
         `CASOS ACUM` = Confirmados.PCR.TA,
         `DEFUNCIONES ACUM` = Defunciones) %>%
  mutate(IA.14d = round(IA.14d))

library(DT)

datatable(muni.dt, rownames = FALSE, filter = "top", width = '100%', 
          options = list(scrollX = TRUE,
                         language = list(url = '//cdn.datatables.net/plug-ins/1.10.22/i18n/Spanish.json')))
```

<br>
<br>

### Evolución de casos, incidencia acumulada y defunciones por municipio {#appmunicipios}


<br>


Seleccione provincia y municipio para visualizar el número de casos confirmados, incidencia acumulada y defunciones por municipio.

<br>

```{r shiny.muni, out.width='100%'}
include_app("https://frodsan.shinyapps.io/COVID19-Municipios-Andalucia/", 
            height = '750px')
```


<br>

La Junta de Andalucía ha comenzado a visualizar los datos diarios por provincia, distrito sanitario y municipio [aquí](http://www.juntadeandalucia.es/institutodeestadisticaycartografia/salud/COVID19.html).

<br>







```{r test.posit, out.width='100%', eval=FALSE}

### Porcentaje de PCR positivas

# Aquí se muestra el número de PCR realizadas en Andalucía cada semana (según los datos ofrecidos por [Datadista](https://github.com/datadista/datasets/tree/master/COVID%2019)), el número de casos detectados esa semana y, en consecuencia, el porcentaje de PCR positivas. Si el porcentaje de pruebas positivas es elevado es probable que no se estén detectando todos los casos y por tanto no se estén cortando bien las cadenas de transmisión. La OMS recomienda que este porcentaje se mantenga por debajo del 5%. 

ntest <- readr::read_csv("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_test_realizados.csv") %>%
  filter(cod_ine == "01") %>%
  select(Fecha, cod_ine, CCAA, PCR)

# datos.andal$casos.7d <- zoo::rollsumr(datos.andal$ConfirmadosPCR, k = 7, fill = NA)

datos.andal <- datos.andal %>%
  mutate(casos.acum = cumsum(ConfirmadosPCR))

ntest <- datos.andal %>%
  select(Fecha, casos.acum) %>%
  right_join(ntest, by = "Fecha") %>%
  arrange(Fecha) %>%
  mutate(pcr.7d = PCR - lag(PCR),
         casos.7d = casos.acum - lag(casos.acum)) %>%
  mutate(pos.percent = 100*round(casos.7d/pcr.7d, digits = 3)) %>%
  select(Fecha, pcr.7d, casos.7d, pos.percent) %>%
  tidyr::pivot_longer(cols = pcr.7d:pos.percent) %>%
  mutate(name = case_when(
    name =="pcr.7d" ~ "PCR semanales realizadas",
    name == "casos.7d" ~ "Casos confirmados",
    name == "pos.percent" ~ "Porcentaje de PCR positivas"
  )) %>%
  mutate(name = factor(name, levels = c("PCR semanales realizadas", "Casos confirmados", "Porcentaje de PCR positivas"))) %>%
  filter(Fecha > "2020-04-23")

ggplot(ntest) + 
  facet_wrap(~name, ncol = 1, scales = "free_y") +
  geom_line(aes(Fecha, value, colour = name), size = 2) +
  ylim(0, NA) +
  scale_colour_manual(values = c("grey60", "#ff7f00", "black")) +
  theme(legend.position = "none") +
  labs(x = "", y = "",
       #title = "Porcentaje de personas con PCR positiva",
       caption = "https://tiny.cc/COVID19-Andalucia")
  

```


<br>



## Casos confirmados por sexo y rango de edad

<br>

Número de casos e Incidencia Acumulada por franja de edad:

<br>

```{r }
casos.edad.provs %>% 
  filter(Territorio == "Andalucía", Edad != "TOTAL") %>% 
  select(Edad, Casos.14d, IA.14d, Casos.7d, IA.7d) %>% 
  mutate(Edad = str_remove_all(Edad, "De "),
         Edad = str_remove(Edad, " años")) %>% 
  mutate(IA.14d = round(IA.14d),
         IA.7d = round(IA.7d)) %>% 
  kable()

  
```
<br>

Esta figura representa los rangos de edad de los casos confirmados por PCR o test de antígeno a lo largo del tiempo (desde el 15 de Marzo de 2020). 

<br>


```{r casos.edad.heatmap, out.width='100%', fig.height=2.5}

## 2021-07-11: now using data from ISCII

# casos.edad.fecha %>%
#   filter(Fecha > "2020-03-14") %>%
#   ggplot() +
#   geom_tile(aes(x = Fecha, y = edades, fill = Casos)) +
#   scale_fill_viridis_c() +
#   labs(y = "Edad", x = "",
#        title = "Edad de los casos confirmados",
#        caption = "https://tiny.cc/COVID19-Andalucia",
#        fill = "Casos\ndiarios") +
#   scale_x_date(date_breaks = "1 month", date_labels = "%b") +
#   theme(legend.title = element_text(size = 12))


datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(casos = sum(casos)) %>% 
  filter(fecha >= as.Date("2020-08-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = casos)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de los casos confirmados",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Casos\ndiarios") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```

<br>


```{r casos.edad.anim, out.width='100%', eval = FALSE}

library(gganimate)

edad.anim.df <-
  casos.edad.fecha %>%
  mutate(edades = factor(edades,
                         levels = (c("0 - 14", "15 - 29", "30 - 44", "45 - 64", "65 - 84", "85 y más")))) %>%
  filter(Fecha >= "2020-07-01")
    
edad.anim <- 
  ggplot(edad.anim.df) +
  geom_col(aes(x = edades, y = Casos), fill = "#ff7f00") +
  #transition_states(Fecha, wrap = FALSE) +
  transition_manual(frames = Fecha) +
  labs(y = "Número de casos diarios \n", x = "Edad",
       title = "Edad de los casos confirmados por PCR",
       subtitle = "{current_frame}",
       caption = "https://tiny.cc/COVID19-Andalucia") 

animate(edad.anim, height = 4, width = 5, units = "in", res = 150, 
        rewind = FALSE, 
        nframes = length(unique(edad.anim.df$Fecha)),
        fps = 8)

anim_save("edad_casos_anim.gif")

    
```


Aquí se representan los mismos datos (casos diarios confirmados por categoría de edad) usando medias móviles a 7 días para reducir la variación diaria y facilitar la visualización de tendencias:



```{r casos.edad.lines, out.width='100%'}

casos.edad.fecha$edades <- factor(casos.edad.fecha$edades,
                                  levels = rev(levels(casos.edad.fecha$edades)))

casos.edad.fecha %>%
  group_by(edades) %>%
  mutate(casos_ma = zoo::rollmean(Casos, 7, fill = NA, align = "right")) %>%
  ungroup() %>%
  filter(Fecha >= as.Date("2021-01-01")) %>%
  ggplot() +
  geom_line(aes(x = Fecha, y = casos_ma, colour = edades),
            size = 1.5) +
  scale_x_date(limits = c(as.Date(NA), max(casos.edad.fecha$Fecha) - 1), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Casos\n", x = "",
       title = "Casos diarios por franja de edad",
       subtitle = "Para cada edad se representa el nº medio de casos diarios\nen los 7 días previos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
    scale_color_manual(values = c("#ffff33", "#e41a1c", "#984ea3",
                                "#377eb8", "#4daf4a", "#999999")) +
  # scale_color_brewer(type = "seq", palette = "YlGnBu") +
  theme(legend.title = element_text(hjust = 0.5))

```


```{r casos.edad.lines.iscii, eval=FALSE}

## using data from ISCII

casos.edad.fecha.iscii %>% 
  filter(fecha >= as.Date("2021-01-01")) %>%
  ggplot() +
  geom_line(aes(x = fecha, y = casos_ma, colour = grupo_edad),
            size = 1.5) +
  scale_x_date(limits = c(as.Date(NA), max(casos.edad.fecha.iscii$fecha) - 5), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Casos\n", x = "",
       title = "Casos diarios por franja de edad",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  theme(legend.title = element_text(hjust = 0.5))

```

<br>

La siguiente figura muestra la Incidencia Acumulada (número de casos en los últimos 14 días por cada 100.000 habitantes) teniendo en cuenta el número de personas en cada franja de edad:

```{r ia14.edad}
casos.edad.fecha %>% 
  # group_by(edades) %>% 
  # mutate(IA14_ma = zoo::rollmean(IA.14d, 7, fill = NA)) %>% 
  # ungroup() %>% 
  filter(Fecha >= as.Date("2021-01-01")) %>% 
ggplot() +
  geom_line(aes(x = Fecha, y = IA.14d, colour = edades),
            size = 1.5) +
  scale_x_date(limits = c(as.Date(NA), max(casos.edad.fecha$Fecha) - 1), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Incidencia Acumulada\n", x = "",
       title = "Incidencia Acumulada 14 días por franja de edad",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_manual(values = c("#ffff33", "#e41a1c", "#984ea3",
                                "#377eb8", "#4daf4a", "#999999")) +
  theme(legend.title = element_text(hjust = 0.5))
```


```{r ia14.edad.iscii, eval = FALSE}

casos.edad.fecha.iscii %>% 
  filter(fecha >= as.Date("2021-01-01")) %>% 
ggplot() +
  geom_line(aes(x = fecha, y = IA.14d, colour = grupo_edad),
            size = 1.5) +
  scale_x_date(limits = c(as.Date(NA), max(casos.edad.fecha.iscii$fecha) - 1), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Incidencia Acumulada\n", x = "",
       title = "Incidencia Acumulada 14 días por franja de edad",
       subtitle = "Casos confirmados en los últimos 14 días por cada 100.000 habitantes",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  theme(legend.title = element_text(hjust = 0.5))

```



```{r casos.sexo.edad.5a, eval=FALSE}

# Esta figura representa la variación semanal en número de casos detectados según sexo y edad (en intervalos de 5 años): 
  
datos.edad.sexo <- readr::read_csv("datos/datos_edad_sexo.csv") %>% 
  filter(Fecha > as.Date("2020-10-21")) %>% 
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>% 
  mutate(edades = str_replace(edades, " y más", "+")) %>% 
  mutate(edades = factor(edades, levels = gtools::mixedsort(unique(edades))))

casos.sexo.edad.5a <- datos.edad.sexo %>% 
  select(Fecha, edades, Sexo, Confirmados) %>% 
  group_by(edades, Sexo) %>% 
  mutate(Casos.week = Confirmados - lag(Confirmados)) %>% 
  filter(Fecha > as.Date("2020-10-22"))

casos.sexo.edad.5a %>% 
  group_by(Fecha, edades) %>% 
  summarise(Casos.week.ambosex = sum(Casos.week)) %>% 
  # filter(! edades %in% c("100+")) %>%
ggplot() + 
  facet_wrap(~edades, ncol = 1, scales = "free_y") +
  geom_line(aes(x = Fecha, y = Casos.week.ambosex), colour = "#ff7f00", size = 1.5) +
  # scale_colour_manual(values = c("#ff7f00", "#984ea3")) +
  labs(y = "Casos\n", x = "",
       title = "Casos semanales por intervalo de edad",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(legend.position = "top", legend.title = element_blank(),
        strip.text = element_text(size = 8))

# ggsave("casos_edad_largo.pdf", width = 5, height = 15)
  
```

<br>


A continuación se representan los **casos confirmados por sexo y rango de edad**:

```{r casos.heatmap.edad.hombres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "H") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(casos = sum(casos)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = casos)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de los casos confirmados",
       subtitle = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Casos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))
```


```{r casos.heatmap.edad.mujeres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "M") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(casos = sum(casos)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = casos)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de los casos confirmados",
       subtitle = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Casos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


<br>

## Ingresos en centros hospitalarios

<br>


```{r ingresos_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8", alpha = 0.2) +
  geom_line(aes(x = Fecha, y = zoo::rollmean(Hospitalizados, 7, fill = NA)),
            colour = "#377eb8", size = 1.5) +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.andal$Fecha) - 5),
               date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month")

```


<br>


```{r ingresos_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %b") +
  geom_text(aes(Fecha, y = Hospitalizados + 5, label = Hospitalizados),
            data = subset(datos.andal, Fecha > (Sys.Date() - 16))) 
  

```

<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevos ingresos asignados a fechas pasadas. Por tanto, **un descenso en el número de hospitalizaciones en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.


<br>




```{r ingresos_provincias, out.width='100%', fig.height=6}

datos.provs %>% 
  group_by(Territorio) %>% 
  mutate(hosp_ma = zoo::rollmean(Hospitalizados, 7, fill = NA)) %>% 
  ungroup() %>% 
ggplot() +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8", alpha = 0.2) +
  geom_line(aes(x = Fecha, y = hosp_ma), colour = "#377eb8", size = 1) +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias la escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.provs$Fecha) - 5))

```


<br>


```{r ingresos_provincias.14d, out.width='100%', fig.height=6}

ggplot(datos.provs) +
  facet_wrap(~Territorio, ncol = 2) +
  geom_col(aes(x = Fecha, y = Hospitalizados), 
            fill = "#377eb8") +
  labs(x = "", y = "Nº Ingresos\n",
       title = "Hospitalizaciones diarias con COVID-19 en cada provincia",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "4 days", date_labels = "%d %b") +
  scale_y_continuous(limits = c(0, NA), sec.axis = dup_axis(name = ""))

```

<br>

### Ingresos por sexo y rango de edad

<br>

Número de personas ingresadas por cada rango de edad desde el inicio de la pandemia:

<br>

```{r edad.ingresos}
hosp.edad <- read_csv2("datos/edad.sexo/datos_hosp_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "Hospitalizados") %>%
  filter(!is.na(Edad)) %>% 
  mutate(edad.grupo = factor(sort(rep(1:21, 2)))) %>% 
  group_by(Edad, edad.grupo) %>% 
  summarise(n = sum(Valor)) %>% 
  ungroup()
  

## Obtener etiquetas edades
library(stringr)
hosp.edad <- hosp.edad %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>% 
  arrange(edad.grupo) %>% 
  mutate(edades.f = factor(edades, levels = edades))


ggplot(hosp.edad) +
  coord_flip() +
  geom_col(aes(x = edades.f, y = n), fill = "#377eb8") + 
  geom_text(aes(x = edades.f, y = n + 180, label = n), size = 3) +
  labs(x = "Edad (años)", y = "", 
       title = "Número de ingresos por rango de edad",
       subtitle = paste0("Total de ingresados: ", sum(hosp.edad$n), " (con fecha ", fecha.edad, ")"),
       caption = "https://tiny.cc/COVID19-Andalucia") 

```


<br>

A continuación el número de ingresos diarios por rango de edad y sexo:

<br>

```{r ingresos.heatmap.edad, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(hosp = sum(hosp)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = hosp)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas ingresadas",
       subtitle = "Ambos sexos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Ingresos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


```{r ingresos.heatmap.edad.hombres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "H") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(hosp = sum(hosp)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = hosp)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas ingresadas",
       subtitle = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Ingresos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


```{r ingresos.heatmap.edad.mujeres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "M") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(hosp = sum(hosp)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = hosp)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas ingresadas",
       subtitle = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Ingresos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


<br>


```{r ingresos.edad.lines, out.width='100%'}

library(ggrepel)

ing.lines <- datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(hosp = sum(hosp)) %>% 
  filter(fecha >= as.Date("2021-01-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = unique(grupo_edad))) %>% 
  group_by(edades) %>% 
  mutate(hosp_ma = zoo::rollmean(hosp, 14, fill = NA, align = "right")) %>% 
  ungroup() 


ggplot(ing.lines) +
  geom_line(aes(x = fecha, y = hosp_ma, colour = edades),
            size = 1.5) +
  scale_x_date(limits = c(as.Date(NA), max(datos.diarios.iscii.notna$fecha) - 2), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Ingresos\n", x = "",
       title = "Ingresos diarios por franja de edad",
       subtitle = "Para cada edad se representa el nº medio de ingresos diarios\nen los 14 días previos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  theme(legend.title = element_text(hjust = 0.5)) 

```


```{r fig.height=7}

# library(gghighlight)

ing.lines.zoom <- ing.lines %>%
  filter(fecha > "2021-09-01") %>%
  filter(fecha < max(ing.lines$fecha) - 1)

ggplot(data = ing.lines.zoom,
       aes(x = fecha, y = hosp_ma)) +
  geom_line(aes(colour = edades),
            size = 1.5, show.legend = TRUE, alpha = 0.8) +
  geom_text_repel(data = filter(ing.lines.zoom, fecha == max(ing.lines.zoom$fecha)),
                  aes(label = edades, colour = edades),
                  min.segment.length = 0, 
                  nudge_x = 5,
                  show.legend = FALSE) +
  scale_x_date(date_breaks = "1 week", date_labels = "%d %b", 
               date_minor_breaks = "1 week", expand = expansion(add = c(3, 12))) +
  labs(y = "Nº Ingresos\n", x = "",
       title = "\nIngresos diarios por franja de edad",
       subtitle = "Para cada edad se representa el nº medio de ingresos diarios\nen los 14 días previos",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  theme(legend.title = element_blank(), legend.position = "bottom",
        legend.text = element_text(size = 9, colour = "grey20")) +
  theme(axis.text.x = element_text(size = 8)) 
  # gghighlight(grupo_edad == "0-9" | grupo_edad == "10-19", 
  #             unhighlighted_params = list(colour = NULL, alpha = 0.3), 
  #             use_direct_label = FALSE, keep_scales = TRUE)



```

<br>


## Ingresos en cuidados intensivos (UCI) {#uci}

<br>


```{r uci_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c", alpha = 0.25) +
  geom_line(aes(x = Fecha, y = zoo::rollmean(UCI, 7, fill = NA)),
            colour = "#e41a1c", size = 1.5) +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.andal$Fecha) - 5),
               date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month")

```


<br>


```{r uci_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %b") 

```
<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevos ingresos asignados a fechas pasadas. Por tanto, **un descenso en el número de ingresos en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.

<br>


```{r uci_provincias, out.width='100%', eval=FALSE}

ggplot(datos.provs) +
  facet_wrap(~Territorio, scales = "free_y", ncol = 2) +
  geom_col(aes(x = Fecha, y = UCI), fill = "#e41a1c") +
  ylim(0, NA) +
  labs(x = "", y = "Nº Ingresos UCI\n",
       title = "Ingresos diarios en UCI en cada provincia",
       subtitle = "Para facilitar la visualización de tendencias, la escala del eje vertical es diferente cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8))

```


<br>

### Ingresos en UCI por sexo y rango de edad

<br>


Número de personas ingresadas en UCI por cada rango de edad desde el inicio de la pandemia:

<br>

```{r edad.uci}
uci.edad <- read_csv2("datos/edad.sexo/datos_uci_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "Casos UCI") %>%
  filter(!is.na(Edad)) %>% 
  mutate(edad.grupo = factor(sort(rep(1:21, 2)))) %>% 
  group_by(Edad, edad.grupo) %>% 
  summarise(n = sum(Valor)) %>% 
  ungroup()
  

## Obtener etiquetas edades
library(stringr)
uci.edad <- uci.edad %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>% 
  arrange(edad.grupo) %>% 
  mutate(edades.f = factor(edades, levels = edades))


ggplot(uci.edad) +
  coord_flip() +
  geom_col(aes(x = edades.f, y = n), fill = "#e41a1c") + 
  geom_text(aes(x = edades.f, y = n + 35, label = n), size = 3) +
  labs(x = "Edad (años)", y = "", 
       title = "Número de ingresos en UCI por rango de edad",
       subtitle = paste0("Total de ingresados: ", sum(uci.edad$n), " (con fecha ", fecha.edad, ")"),
       caption = "https://tiny.cc/COVID19-Andalucia") 

```


<br>



```{r uci.heatmap.edad, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(uci = sum(uci)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = uci)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas ingresadas en UCI",
       subtitle = "Ambos sexos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Ingresos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


```{r uci.heatmap.edad.hombres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "H") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(uci = sum(uci)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = uci)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas ingresadas en UCI",
       subtitle = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Ingresos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


```{r uci.heatmap.edad.mujeres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "M") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(uci = sum(uci)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = uci)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas ingresadas en UCI",
       subtitle = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Ingresos\ndiarios") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


<br>



```{r uci.edad.lines}

uci.lines <- datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(uci = sum(uci)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = unique(grupo_edad))) %>% 
  group_by(edades) %>% 
  mutate(uci_ma = zoo::rollmean(uci, 14, fill = NA, align = "right")) %>% 
  ungroup() 


ggplot(uci.lines) +
  geom_line(aes(x = fecha, y = uci_ma, colour = edades),
            size = 1.5) +
  scale_x_date(limits = c(as.Date("2021-01-01"), max(datos.diarios.iscii.notna$fecha) - 1), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Ingresos UCI\n", x = "",
       title = "Ingresos diarios en UCI por franja de edad",
       subtitle = "Para cada edad se representa el nº medio de ingresos en UCI\nen los 14 días previos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  theme(legend.title = element_text(hjust = 0.5))


uci.lines %>% 
  filter(fecha > as.Date("2021-09-01")) %>% 
ggplot() +
  geom_line(aes(x = fecha, y = uci_ma, colour = edades),
            size = 1.5, alpha = 0.8) +
  scale_x_date(limits = c(as.Date(NA), max(uci.lines$fecha) - 1), 
               date_breaks = "1 week", date_labels = "%d %b") +
  labs(y = "Ingresos UCI\n", x = "",
       title = "Ingresos diarios en UCI por franja de edad",
       subtitle = "Para cada edad se representa el nº medio de ingresos en UCI\nen los 14 días previos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  theme(legend.title = element_text(hjust = 0.5))


```

<br>


## Defunciones

<br>

```{r fallecidos_Andalucia, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Defunciones), fill = "grey40", alpha = 0.25) +
  geom_line(aes(x = Fecha, y = zoo::rollmean(Defunciones, 7, fill = NA)),
            colour = "grey40", size = 1.5) +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias con COVID-19 en Andalucía",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.andal$Fecha) - 5),
               date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month")

```

<br>

```{r fallecidos_Andalucia.14d, fig.height=3, out.width='100%'}

ggplot(datos.andal) +
  geom_col(aes(x = Fecha, y = Defunciones), fill = "grey40") +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias con COVID-19 en Andalucía",
       subtitle = "Últimos 14 días",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_date(limits = c(Sys.Date() - 16, NA), 
               date_breaks = "2 days", date_labels = "%d %b") 

```

<br>

**NOTA**: el retraso (de varios días) en las notificaciones hace que las curvas parezcan a menudo descendentes. Frecuentemente, en los días siguientes se añaden nuevas defunciones asignadas a fechas pasadas. Por tanto, **un aparente descenso en el número de defunciones en los últimos días no debe interpretarse como un descenso en la intensidad de la pandemia** hasta que los datos sean consolidados en los próximos días.

<br>

```{r fallecidos_provincias, out.width='100%', fig.height=6}
     
datos.provs %>% 
  group_by(Territorio) %>% 
  mutate(def_ma = zoo::rollmean(Defunciones, 7, fill = NA)) %>% 
  ungroup() %>% 
ggplot() +
  facet_wrap(~Territorio, ncol = 2, scales = "free_y") +  
  geom_col(aes(x = Fecha, y = Defunciones), 
            size = 1.5, fill = "grey40", alpha = 0.2) +
  geom_line(aes(x = Fecha, y = def_ma), colour = "grey40", size = 1) +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "", y = "Nº Defunciones\n",
       title = "Defunciones diarias con COVID-19 en cada provincia",
       subtitle = "La escala del eje vertical es diferente en cada provincia",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(axis.text.x = element_text(size = 8)) +
  scale_x_date(limits = c(as.Date("2020-03-01"), max(datos.provs$Fecha) - 5))

```

<br>

### Defunciones por sexo y rango de edad

<br>


Número de defunciones por cada rango de edad desde el inicio de la pandemia:

<br>

```{r edad.def}
def.edad <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "Fallecidos") %>%
  filter(!is.na(Edad)) %>% 
  mutate(edad.grupo = factor(sort(rep(1:21, 2)))) %>% 
  group_by(Edad, edad.grupo) %>% 
  summarise(n = sum(Valor)) %>% 
  ungroup()
  

## Obtener etiquetas edades
library(stringr)
def.edad <- def.edad %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>% 
  arrange(edad.grupo) %>% 
  mutate(edades.f = factor(edades, levels = edades))


ggplot(def.edad) +
  coord_flip() +
  geom_col(aes(x = edades.f, y = n), fill = "grey40") + 
  geom_text(aes(x = edades.f, y = n + 60, label = n), size = 3) +
  labs(x = "Edad (años)", y = "", 
       title = "Defunciones por rango de edad",
       subtitle = paste0("Defunciones acumuladas: ", sum(def.edad$n), " (con fecha ", fecha.edad, ")"),
       caption = "https://tiny.cc/COVID19-Andalucia") 

```


<br>


```{r def.heatmap.edad, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(def = sum(def)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = def)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas fallecidas",
       subtitle = "Ambos sexos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Defunciones\ndiarias") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


```{r def.heatmap.edad.hombres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "H") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(def = sum(def)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = def)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas fallecidas",
       subtitle = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Defunciones\ndiarias") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))
```


```{r def.heatmap.edad.mujeres, out.width='100%', fig.height=3}

datos.diarios.iscii.notna %>% 
  filter(sexo == "M") %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(def = sum(def)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = rev(unique(grupo_edad)))) %>% 
  ggplot() +
  geom_tile(aes(x = fecha, y = edades, fill = def)) +
  scale_fill_viridis_c() +
  labs(y = "Edad", x = "",
       title = "Edad de las personas fallecidas",
       subtitle = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia",
       fill = "Defunciones\ndiarias") +
  scale_x_date(date_breaks = "2 months", date_labels = "%b",
               date_minor_breaks = "1 month") +
  theme(legend.title = element_text(size = 12),
        axis.text = element_text(size = 10))

```


<br>



```{r def.edad.lines}

datos.diarios.iscii.notna %>% 
  group_by(fecha, grupo_edad) %>% 
  summarise(def = sum(def)) %>% 
  filter(fecha >= as.Date("2020-03-01")) %>% 
  mutate(edades = factor(grupo_edad, levels = unique(grupo_edad))) %>% 
  group_by(edades) %>% 
  mutate(def_ma = zoo::rollmean(def, 7, fill = NA, align = "right")) %>% 
  ungroup() %>% 
  ggplot() +
  geom_line(aes(x = fecha, y = def_ma, colour = edades),
            size = 1.5) +
  scale_x_date(limits = c(as.Date("2021-01-01"), max(datos.diarios.iscii.notna$fecha) - 1), 
               date_breaks = "1 month", date_labels = "%b") +
  labs(y = "Defunciones\n", x = "",
       title = "Defunciones diarias por franja de edad",
       subtitle = "Para cada edad se representa el nº medio de defunciones\nen los 14 días previos",
       caption = "https://tiny.cc/COVID19-Andalucia",
       colour = "Edad") +
  scale_color_brewer(type = "seq", palette = "YlGnBu") +
  # scale_color_manual(values = c("#ffff33", "#e41a1c", "#984ea3",
  #                               "#377eb8", "#4daf4a", "#999999")) +
  # geom_text(data = casos.edad.last, aes(Fecha - 20, Casos, label = edades)) +
  theme(legend.title = element_text(hjust = 0.5))

```

<br>



## Distribución global por edad y sexo {#edad-sexo}

Cada barra representa el % de casos, ingresos, o defunciones representado por personas de dicho sexo y categoría de edad.
<br>

```{r dist.edad.sexo, out.width='100%', fig.height=4}

casos.edad.sexo <- read_csv2("datos/edad.sexo/datos_casos_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Casos") %>%
  filter(!is.na(Edad))


hosp.edad.sexo <- read_csv2("datos/edad.sexo/datos_hosp_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Hospitalizaciones") %>%
  filter(!is.na(Edad))


uci.edad.sexo <- read_csv2("datos/edad.sexo/datos_uci_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% UCI") %>%
  filter(!is.na(Edad))


def.edad.sexo <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "% pirámide") %>%
  mutate(Medida = "% Defunciones") %>%
  filter(!is.na(Edad)) %>%
  right_join(casos.edad.sexo[, c("Edad", "Sexo")], by = c("Edad", "Sexo")) %>%
  mutate(Medida = "% Defunciones")

# Sept 2020: ya no proveen esta información
# recup.edad.sexo <- read_csv2("datos/edad.sexo/datos_curados_edad_sexo.csv",
#                           locale = locale(date_names = "es", 
#                                           decimal_mark = ",",
#                                           grouping_mark = "."),
#                           skip_empty_rows = TRUE) %>%
#   select(-X5) %>%
#   filter(Medida == "% pirámide") %>%
#   mutate(Medida = "% Recuperados") %>%
#   filter(!is.na(Edad))


## Obtener etiquetas edades
library(stringr)
edades <- casos.edad.sexo %>%
  filter(Sexo == "Hombres") %>%
  mutate(edades = str_replace(Edad, "De ", "")) %>%
  mutate(edades = str_replace(edades, " a ", " - ")) %>%
  mutate(edades = str_replace(edades, " años", "")) %>%
  pull(edades)
  #mutate(edades = rev(edades))


## Juntar todas las variables

todo.edad.sexo <- bind_rows(casos.edad.sexo, 
                            hosp.edad.sexo,
                            uci.edad.sexo,
                            def.edad.sexo) %>%
  group_by(Sexo, Medida) %>%
  mutate(edades = factor(edades, levels = edades)) %>%
  ungroup() %>%
  mutate(Medida = factor(Medida, levels = c("% Casos", 
                                            "% Hospitalizaciones", "% UCI", "% Defunciones")))


## Fig hombres
todo.edad.sexo %>%
  filter(Sexo == "Hombres") %>%
ggplot() +
  facet_wrap(~Medida, nrow = 1) + 
  coord_flip() +
  geom_col(aes(x = edades, y = Valor), fill = "#ff7f00") +
  labs(x = "Edad (años)", y = "Porcentaje (%)", title = "Hombres",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(title = element_text(size = 15),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 10))


## Fig mujeres
todo.edad.sexo %>%
  filter(Sexo == "Mujeres") %>%
ggplot() +
  facet_wrap(~Medida, nrow = 1) + 
  coord_flip() +
  geom_col(aes(x = edades, y = Valor), fill = "#984ea3") +
  labs(x = "Edad (años)", y = "Porcentaje (%)", title = "Mujeres",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  theme(title = element_text(size = 15),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2))

```



<br>



## Letalidad

<br>

Aquí se representa, para cada sexo y franja de edad, la proporción de casos confirmados de COVID-19 que acaban en defunción (lo que en inglés se conoce como [Case Fatality Rate](https://en.wikipedia.org/wiki/Case_fatality_rate)). Estos valores sirven para tener una idea aproximada de la letalidad del virus, aunque la probabilidad individual de defunción depende de muchos otros factores (otras enfermedades, mejoras en los tratamientos, etc). Los valores que aquí se presentan además no tienen en cuenta las defunciones que pueden ocurrir en las próximas semanas de personas ahora infectadas. Ni las defunciones debidas a COVID-19 pero no diagnosticadas.

En cualquier caso, es evidente que la letalidad aumenta con la edad y es mayor en hombres que en mujeres. 

<br>

```{r letalidad, out.width='100%', fig.height=5}

casos.edad.sexo <- read_csv2("datos/edad.sexo/datos_casos_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "Confirmados PDIA") %>%
  filter(!is.na(Edad)) %>%
  rename(Casos = Valor) %>%
  select(-Medida)

def.edad.sexo <- read_csv2("datos/edad.sexo/datos_def_edad_sexo.csv",
                          locale = locale(date_names = "es", 
                                          decimal_mark = ",",
                                          grouping_mark = "."),
                          skip_empty_rows = TRUE) %>%
  select(Edad:Valor) %>%
  filter(Medida == "Fallecidos") %>%
  filter(!is.na(Edad))  %>%
  rename(Fallecidos = Valor) %>%
  select(-Medida)


cfr <- left_join(casos.edad.sexo, def.edad.sexo, by = c("Edad", "Sexo")) %>%
  mutate(Fallecidos = ifelse(is.na(Fallecidos), 0, Fallecidos)) %>%
  mutate(CFR = 100*Fallecidos/Casos) %>%
  filter(Edad != "De 100 y más años") %>%
  mutate(edades = factor(rep(edades[-1], each = 2), levels = edades[-1]))


ggplot(cfr) +
  facet_wrap(~Sexo, ncol = 2, scales = "free_x") +
  geom_col(aes(edades, CFR, fill = Sexo)) +
  coord_flip() +
  labs(y = "Porcentaje de casos que acaban en defunción (%)", x = "Edad\n", 
       title = "Letalidad por COVID-19 en Andalucía",
       subtitle = "Proporción de muertes respecto al número de casos confirmados\nen cada categoría de edad y sexo",
       caption = "https://tiny.cc/COVID19-Andalucia") +
  scale_fill_manual(values = c("#ff7f00", "#984ea3")) +
  theme(legend.position = "none")

```

<br>

## Comparación con otras CCAA {#ccaa}

<br>

Andalucía es de las comunidades autónomas que [menos test ha realizado](https://elpais.com/sociedad/2020-04-27/la-rioja-hace-siete-veces-mas-pruebas-pcr-por-habitante-que-andalucia.html) en relación al tamaño de su población (al menos hasta mediados de Abril). Por tanto el número de casos de COVID-19 puede estar notablemente infraestimado. De hecho, los primeros resultados del estudio serológico indican que [en Andalucía se han detectado probablemente menos del 10% de los contagios](https://www.eldiario.es/sociedad/porcentaje-poblacion-contagiada-explosivo-COVID-19_0_1026798481.html). En general, no debemos comparar el número de casos entre comunidades sin tener en cuenta la enorme variación en el número de test realizados.

<br>

```{r test.ccaa, out.width='100%'}
test.ccaa <- readxl::read_excel("datos/ntest_casos_ccaa_14Apr.xlsx")

set.seed(123)
ggplot(test.ccaa) +
  geom_point(aes(Ntest.pop, Casos.pop), size = 2) +
  ggrepel::geom_text_repel(aes(x = Ntest.pop, y = Casos.pop, label = CCAA),
                           size = 3, nudge_x = 10, nudge_y = 30) +
  scale_x_continuous(name = "\nNúmero de test por 100.000 habitantes",
                     limits = c(0, NA)) +
  scale_y_continuous(name = "Número de casos por 100.000 habitantes\n",
                     limits = c(0, NA)) +
  labs(title = "Número de casos detectados en relación al número de test\nrealizados por CC.AA.",
       caption = "Datos a 14 de Abril (Fuente: https://datos.civio.es)\nhttps://tiny.cc/COVID19-Andalucia") 
```

<br>
<br>


```{r confirmados.ccaa, fig.height=5, out.width='100%'}

ccaa.pcr <- readr::read_csv("https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_datos_isciii_nueva_serie.csv", guess_max = 10000) 

library(plotly)

options(scipen = 1000)

ggplotly(
  ggplot(ccaa.pcr) +
  geom_line(aes(x = fecha, y = num_casos_prueba_pcr, group = ccaa), 
              colour = "grey80") +
  geom_line(aes(x = fecha, y = num_casos_prueba_pcr), 
            data = subset(ccaa.pcr, ccaa == "Andalucía"), 
            colour = "#ff7f00", size = 2) +
  #scale_y_log10() +
  labs(x = "", y = "Confirmados PCR\n",
       title = "Casos de COVID-19 confirmados por PCR en cada CCAA",
       #subtitle = "Escala logarítmica",
       caption = "https://tiny.cc/COVID19-Andalucia")
)

```




<br>

Realizado por [Francisco Rodríguez Sánchez](https://twitter.com/frod_san) a partir de los [datos](https://github.com/Pakillo/COVID19-Andalucia/tree/master/datos) ofrecidos por la Consejería de Salud y Familias de la Junta de Andalucía, el Ministerio de Sanidad, la Fundación CIVIO y Datadista. Reproducción permitida con fines no comerciales citando la fuente (CC-BY-NC 4.0).


